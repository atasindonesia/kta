<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>SAPA KTA ATAS Indonesia</title>
    <link rel="icon" type="image/png" href="./logo-kta.png">


  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Poppins:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

  <style>
  /* =========================================
     1. ROOT VARIABLES & GLOBAL RESET
     ========================================= */
  :root { 
    --primary-grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
    --bg-body: #f3f4f6; 
    --text-dark: #1e293b; 
    --text-gray: #64748b; 
    --border: #e2e8f0; 
    --sidebar-width: 270px; 
  }
  
  * { box-sizing: border-box; }
  
  body { 
    font-family: 'Inter', sans-serif; 
    margin: 0; padding: 0;
    background: var(--bg-body); 
    color: var(--text-dark); 
    font-size: 14px; 
    overflow-x: hidden; 
    line-height: 1.5;
  }
  
  h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; margin: 0; } 
  .hidden { display: none !important; }

  /* =========================================
     2. LOADER & SPINNER
     ========================================= */
  #loader { 
    position: fixed; inset: 0; 
    background: rgba(255,255,255,0.9); 
    z-index: 999999; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
  }
  .spinner { 
    width: 50px; height: 50px; border-radius: 50%; 
    background: var(--primary-grad); 
    -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0); 
    animation: spin 1s infinite linear; 
  }
  @keyframes spin { to { transform: rotate(1turn); } }

  /* =========================================
     3. BUTTONS & INPUTS
     ========================================= */
  #scrollTopBtn { 
    display: none; position: fixed; bottom: 85px; right: 20px; z-index: 999; 
    font-size: 18px; border: none; outline: none; background: var(--primary-grad); 
    color: white; cursor: pointer; padding: 12px 18px; border-radius: 50px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; 
  }
  #scrollTopBtn:hover { transform: translateY(-3px); }

  .btn { 
    padding: 10px 18px; border-radius: 30px; border: none; cursor: pointer; 
    font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; 
    justify-content: center; gap: 8px; font-size: 0.9rem; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
  }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  
  .btn-primary { background: var(--primary-grad); color: white; }
  .btn-green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
  .btn-red { background: #fee2e2; color: #dc2626; }
  .btn-orange { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
  .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-dark); }
  .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }

  input, select, textarea { 
    width: 100%; padding: 12px 15px; border: 1px solid var(--border); 
    border-radius: 10px; font-size: 14px; outline: none; transition: 0.3s; background: #f9fafb; 
  }
  input:focus, select:focus, textarea:focus { 
    border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); 
  }
  label { 
    display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-gray); 
    text-transform: uppercase; margin: 15px 0 5px 0; 
  }

  /* =========================================
     4. LOGIN PAGE STYLE
     ========================================= */
  .login-body { 
    min-height: 100vh;
    display: flex; flex-direction: column; 
    align-items: center; justify-content: center; 
    background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); 
    background-size: 400% 400%; animation: gBG 15s ease infinite; padding: 20px; 
  }
  @keyframes gBG { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
  
  .marquee-bar { 
    position: absolute; top: 0; left: 0; width: 100%; 
    background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); 
    padding: 12px 0; color: #4338ca; font-weight: 600; z-index: 50; 
  }
  
  .glass-card { 
    background: rgba(255,255,255,0.9); backdrop-filter: blur(25px); 
    border-radius: 24px; padding: 20px; width: 100%; max-width: 420px; 
    text-align: center; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.25); 
    animation: slideUp 0.8s ease-out; margin-top: 60px; 
  }
  @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }
  
  .logo-anim { 
    max-width: 180px; max-height: 100px; object-fit: contain; margin: 0 auto 20px; 
    display: block; filter: drop-shadow(0 8px 12px rgba(79, 70, 229, 0.3)); 
    animation: floatLogo 6s ease-in-out infinite; 
  }
  @keyframes floatLogo { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
  
  .btn-glow { 
    background: var(--primary-grad); color: white; border: none; padding: 14px; 
    width: 100%; border-radius: 12px; font-weight: 700; margin-top: 25px; transition:0.3s; 
  }
  .btn-glow:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4); }
  
  .contact-icons { 
    display: flex; justify-content: center; gap: 15px; margin-top: 30px; 
    padding-top: 20px; border-top: 1px dashed rgba(0,0,0,0.1); 
  }
  .c-icon { 
    width: 45px; height: 45px; border-radius: 50%; background: #f3f4f6; color: #64748b; 
    display: flex; align-items: center; justify-content: center; font-size: 18px; 
    text-decoration: none; transition: 0.3s; 
  }
  .c-icon:hover { background: #4f46e5; color: white; transform: rotate(360deg); }

  /* =========================================
     5. DASHBOARD LAYOUT & SIDEBAR
     ========================================= */
  .dashboard-layout { display: flex; min-height: 100vh; }
  
  .sidebar { 
    width: var(--sidebar-width); background: white; border-right: 1px solid var(--border); 
    position: fixed; height: 100vh; overflow-y: auto; z-index: 100; transition:0.3s; 
  }
  .sidebar-head { padding: 30px 20px; text-align: center; } 
  .sidebar-head h3 { 
    background: var(--primary-grad); -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; font-weight: 800; font-size: 1.5rem; 
  }
  
  .menu { padding: 10px 15px; } 
  .menu-item { 
    display: flex; align-items: center; gap: 12px; padding: 12px 20px; 
    color: var(--text-gray); text-decoration: none; border-radius: 12px; 
    margin-bottom: 5px; cursor: pointer; transition: 0.2s; font-weight: 500; 
  }
  .menu-item:hover, .menu-item.active { background: #f5f3ff; color: #7c3aed; }
  
  .main { 
    margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); 
    display: flex; flex-direction: column; min-height: 100vh; transition: 0.3s; 
  } 
  
  .content { 
    padding: 30px; flex: 1; max-width: 100%; margin: 0; width: 100%; overflow-x: hidden; 
  }
  
  .card { 
    background: white; border-radius: 16px; padding: 25px; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); 
    margin-bottom: 25px; animation: fadeIn 0.5s ease-out; 
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  /* =========================================
     6. ADMIN COMPONENTS
     ========================================= */
  .admin-header { 
    display: flex; justify-content: space-between; align-items: center; 
    background: white; padding: 20px; border-radius: 16px; margin-bottom: 25px; 
    border: 1px solid var(--border); 
  }
  
  .stat-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 25px; }
  .stat-box { 
    background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); 
    display: flex; align-items: center; gap: 15px; transition: 0.2s; 
  } 
  .stat-box:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
  .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
  
  .c-blue { background: #eff6ff; color: #3b82f6; } 
  .c-green { background: #f0fdf4; color: #16a34a; } 
  .c-red { background: #fef2f2; color: #ef4444; } 
  .c-orange { background: #fff7ed; color: #ea580c; }
  
  .table-box { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; } 
  table { width: 100%; border-collapse: collapse; background: white; }
  th { padding: 15px; text-align: left; background: #f9fafb; font-size: 12px; color: var(--text-gray); text-transform: uppercase; font-weight: 600; white-space: nowrap; } 
  td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
  
  .filters { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; } 
  .filters input { flex: 2; } 
  .filters select { flex: 1; min-width: 150px; }

  /* =========================================
     7. PROFILE HERO (USER VIEW)
     ========================================= */
  .profile-hero { 
    height: 180px; background: var(--primary-grad); border-radius: 16px 16px 0 0; 
    display: flex; align-items: flex-end; padding: 25px; position: relative; margin-bottom: 60px; 
  }
  .hero-avatar { 
    position: absolute; bottom: -50px; left: 30px; width: 130px; height: 130px; 
    border-radius: 15px; border: 5px solid white; object-fit: cover; 
    box-shadow: 0 10px 20px rgba(0,0,0,0.15); background: white; 
  }
  .hero-info { margin-left: 150px; color: white; margin-bottom: 5px; } 
  .hero-name { font-size: 32px; font-weight: 700; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.2); } 
  .hero-role { font-size: 14px; opacity: 0.9; margin-top: 5px; }
  
  .hero-actions { position: absolute; bottom: 25px; right: 30px; display:flex; gap:10px; } 
  .hero-btn { 
    background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); 
    border: 1px solid rgba(255,255,255,0.5); color: white; padding: 10px 20px; 
    border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 13px; 
    font-weight: 600; display:flex; align-items:center; gap:5px;
  } 
  .hero-btn:hover { background: white; color: #4f46e5; }

  .info-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top:10px; }
  .info-card { background: white; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; height: 100%; transition: 0.2s; }
  .info-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
  .info-header { 
    background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid var(--border); 
    font-weight: 700; color: #4f46e5; display: flex; align-items: center; gap: 10px; 
    font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; 
  }
  .info-body { padding: 20px; }
  .data-row { display: flex; justify-content: space-between; border-bottom: 1px dashed var(--border); padding: 8px 0; font-size: 13px; } 
  .data-row:last-child { border: none; }
  .data-label { color: var(--text-gray); font-weight: 500; } 
  .data-val { font-weight: 600; color: var(--text-dark); text-align: right; }

  /* =========================================
     8. MODAL, OVERLAYS & FLOATING BTN
     ========================================= */
  .modal { 
    position: fixed; inset: 0; background: rgba(15,23,42,0.7); backdrop-filter: blur(3px); 
    z-index: 2000; display: flex; justify-content: center; padding-top: 40px; 
    opacity: 0; pointer-events: none; transition: 0.3s; 
  }
  .modal.active { opacity: 1; pointer-events: auto; } 
  .modal-content { 
    background: white; width: 95%; max-width: 800px; border-radius: 20px; 
    padding: 30px; max-height: 85vh; overflow-y: auto; transform: translateY(-20px); 
    transition: 0.3s; 
  } 
  .modal.active .modal-content { transform: translateY(0); }
  
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; } 
  .full-w { grid-column: span 2; }
  
  /* Pastikan popup swal muncul paling atas */
  .swal2-container { z-index: 999999 !important; }
  
  .sidebar-overlay { 
    display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); 
    backdrop-filter: blur(4px); z-index: 95; transition: opacity 0.3s ease; 
  }
  .sidebar-overlay.active { display: block; animation: fadeIn 0.3s ease; }

  .btn-refresh-float { 
    position: fixed; bottom: 85px; right: 20px; z-index: 998; width: 45px; height: 45px; 
    background: white; color: #4f46e5; border-radius: 50%; display: none; 
    align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
    cursor: pointer; border: 1px solid #e2e8f0; transition: 0.3s; 
  }
  .btn-refresh-float:hover { transform: rotate(180deg); background: #f5f3ff; }
  body:not(:has(.login-body)) .btn-refresh-float { display: flex; }

  /* =========================================
     9. TABEL LENGKET & HURUF FLEKSIBEL
     ========================================= */
  #viewData .table-box {
      margin-left: -30px !important; margin-right: -30px !important; 
      width: calc(100% + 60px) !important; 
      border-radius: 0 !important; border-left: none !important; border-right: none !important;
      box-shadow: none !important; border-top: 1px solid var(--border); overflow-x: auto; 
  }
  #viewData table { width: 100%; table-layout: auto; }
  #viewData th, #viewData td {
      font-size: clamp(9px, 1.1vw, 14px); padding: 10px 8px; 
      white-space: nowrap; vertical-align: middle;
  }
  #viewData td:last-child { min-width: 80px; }

  /* =========================================
     10. MOBILE RESPONSIVE & NATIVE APP UI
     ========================================= */
  .mobile-header, .mobile-bottom-bar, .login-bottom-bar { display: none; } 

  @media (max-width: 768px) {
      /* [FIX 1] BUKA KUNCI SCROLL LAYAR HP */
      html, body { 
          width: 100%; max-width: 100%; 
          height: auto !important; min-height: 100vh; 
          overflow-x: hidden; 
          overflow-y: auto !important; 
          background: var(--bg-body); 
          margin: 0; padding: 0;
          -webkit-overflow-scrolling: touch; 
      }
      
      .dashboard-layout { height: auto !important; min-height: 100vh; }
      .sidebar, .admin-header, .org-branding, .desktop-login-actions { display: none !important; }
      
      /* [FIX 2] BUKA KUNCI MAIN CONTENT AGAR BISA DIDORONG KE BAWAH */
      .main { 
          margin-left: 0 !important; width: 100% !important; 
          height: auto !important; min-height: 100vh;
          padding-top: 65px !important; padding-bottom: 90px !important; 
          overflow: visible !important;
      }
      .content { padding: 15px !important; }
      .login-body { padding-bottom: 85px !important; height: auto !important; min-height: 100vh; }

      /* [FIX 3] NAIKKAN POSISI TOMBOL AGAR BISA DIKLIK (TIDAK TERTUTUP LAYAR) */
      .mobile-bottom-bar {
          display: flex; position: fixed; bottom: 0 !important; left: 0; right: 0; width: 100%; height: 65px;
          background: white; align-items: center; justify-content: space-around;
          box-shadow: 0 -2px 15px rgba(0,0,0,0.08); z-index: 9999 !important; margin: 0 !important;
      }
      .login-bottom-bar {
          display: flex; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: 65px;
          background: white; align-items: center; justify-content: space-around;
          box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 9999 !important; margin: 0;
      }

      /* Components HP */
      .form-grid { grid-template-columns: 1fr; } 
      .full-w { grid-column: span 1; } 
      .filters { flex-direction: column; } 
      .filters input, .filters select { width: 100%; } 
      .modal-content { padding: 20px; width: 95%; max-height: 85vh; margin-bottom: 60px; }
      
      /* Tombol Refresh HP */
      .btn-refresh-float { bottom: 85px !important; width: 40px; height: 40px; left: 20px; right: auto; z-index: 998; }

      /* Tabel Mobile */
      #viewData .table-box {
          margin-left: -15px !important; margin-right: -15px !important;
          width: calc(100% + 30px) !important;
      }

      /* Profile Hero HP */
      .profile-hero { 
          height: auto; min-height: 120px !important; flex-direction: column; 
          align-items: center; padding: 20px; margin-bottom: 45px !important; 
      }
      .hero-avatar { 
          position: relative; bottom: -40px !important; left: 0; transform: none; 
          margin: 0 auto; width: 100px !important; height: 100px !important; 
      }
      .hero-info { margin-left: 0; margin-top: 45px !important; text-align: center; width: 100%; }
      .hero-name { font-size: 20px; }
      .hero-actions { display: none !important; }
      .member-content-pad { padding: 15px !important; } 

      /* Header Atas HP */
      .mobile-header {
          display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 65px;
          background: white; align-items: center; justify-content: space-between;
          padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 999;
      }
      .mobile-header-left { display: flex; align-items: center; gap: 12px; }
      .mobile-header-left img { height: 40px; width: auto; object-fit: contain; }
      .mobile-header-left h3 { font-size: 18px; margin: 0; color: var(--text-dark); font-weight: 800; }
      
      .nav-item {
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          color: var(--text-gray); font-size: 22px; width: 20%; cursor: pointer; transition: 0.2s; text-decoration: none;
      }
      .nav-item span { font-size: 10px; font-weight: 600; margin-top: 4px; }
      .nav-item.active { color: #4f46e5; }
      
      /* Menu Tengah (Center FAB) */
      .nav-item-center {
          position: relative; top: -25px; width: 70px; height: 70px; border-radius: 50%;
          background: var(--primary-grad); color: white; display: flex; flex-direction: column;
          justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
          border: 4px solid var(--bg-body); cursor: pointer; font-size: 24px;
      }
      .nav-item-center span { font-size: 9px; margin-top: 2px; font-weight: bold; line-height: 1.2; }

      .login-bottom-bar .nav-item { width: 25%; font-size: 20px; }
  }
</style>
</head>
<body>

  <button onclick="handleManualRefresh()" class="btn-refresh-float" title="Refresh Data">
  <i class="fa fa-sync-alt"></i>
</button>

  <div id="loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:600; color:#4f46e5">MEMUAT...</p></div>
  <div id="app" class="hidden"></div>

  <button onclick="scrollToTop()" id="scrollTopBtn" title="Kembali ke atas"><i class="fa fa-arrow-up"></i></button>

   <div id="searchModal" class="modal">
  <div class="modal-content" style="max-width:400px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
       <h3>Cek Keanggotaan</h3>
       <button onclick="closeModal('searchModal')" style="border:none;background:none;color:red;font-size:24px">&times;</button>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px">
       <button onclick="switchSearchMode('nik')" id="btnModeNik" class="btn btn-sm btn-primary" style="flex:1">Via NIK</button>
       <button onclick="switchSearchMode('bio')" id="btnModeBio" class="btn btn-sm btn-outline" style="flex:1">Via Nama & Tgl.Lahir</button>
    </div>

    <div id="searchBoxNik">
       <input type="text" id="publicNikInput" placeholder="Masukkan NIK/No.KTP (16 Angka)" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px">
    </div>

    <div id="searchBoxBio" style="display:none">
       <input type="text" id="publicNameInput" placeholder="Nama Lengkap (Boleh nama depan)" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:10px">
       <label style="font-size:12px;color:#666">Tanggal Lahir:</label>
       <input type="date" id="publicTglInput" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px">
    </div>

    <button onclick="handlePublicSearch()" class="btn btn-primary" style="width:100%;margin-top:15px"><i class="fa fa-search"></i> CARI DATA ANGGOTA</button>
    
    <div id="searchResultArea" style="display:none;margin-top:15px;background:#f9fafb;padding:15px;border-radius:10px;border:1px dashed #cbd5e1"></div>
  </div>
</div>

  <div id="adminModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h3 style="margin:0">Form Data Anggota</h3>
        <button onclick="closeModal('adminModal')" style="background:none; border:none; font-size:24px; color:#ef4444; cursor:pointer">&times;</button>
      </div>
      <form id="formMember" onsubmit="handleSave(event)">
        <input type="hidden" id="m_row"><input type="hidden" id="m_curFoto"><input type="hidden" id="m_base64">
        
        <div id="superAdminFields" class="hidden" style="background:#fff7ed; padding:15px; border-radius:12px; border:1px dashed #f97316; margin-bottom:20px">
           <h4 style="color:#c2410c; margin-bottom:10px"><i class="fa fa-lock"></i> SUPER ADMIN AREA</h4>
           <div class="form-grid">
              <div>
  <label>Kode Depan (AE)</label>
  <input type="text" id="m_ae" 
         oninput="sanitizeNumber(this)" 
         onchange="validateTwoDigit(this)" 
         placeholder="2 Digit" 
         style="border-color:#fb923c">
</div>

<div>
  <label>Nomor Urut (AF)</label>
  <input type="text" id="m_af" 
         oninput="sanitizeNumber(this)" 
         onchange="validateFourDigit(this)" 
         placeholder="4 Digit" 
         style="border-color:#fb923c;background:#fff">
</div>

<div>
  <label>Kode Prov (AD)</label>
  <input type="text" id="m_ad" 
         oninput="sanitizeNumber(this)" 
         onchange="validateTwoDigit(this)" 
         placeholder="2 Digit" 
         style="border-color:#fb923c">
</div>
              <div class="full-w"><label>Preview NIA (AG) - Murni Angka</label><input type="text" id="m_ag" readonly style="background:#eee; font-weight:bold; color:#c2410c"></div>
           </div>
        </div>

        <div class="full-w" style="margin-bottom:10px; background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd">
            <label style="color:#0369a1">NIA (Nomor Identitas Anggota)</label>
            <input type="text" id="m_nia" readonly style="font-weight:bold; font-size:16px; color:#0369a1; background:white;">
            <small style="color:#64748b">Generated by System</small>
        </div>

        <h4 style="color:#4f46e5;border-bottom:1px solid #eee;margin-bottom:15px">Identitas</h4>
        <div class="form-grid">
           <div><label>ID/NIA</label><input type="text" id="m_id" placeholder="Auto" readonly style="background:#f9fafb"></div>
           <div><label>NIK/No. KTP</label><input type="text" id="m_nik"></div>
           <div class="full-w"><label>Nama</label><input type="text" id="m_nama" placeholder="Isi nama sesuai KTP" required></div>
           <div><label>Gelar Dpn</label><input type="text" id="m_gelarD"></div><div><label>Gelar Blkg</label><input type="text" id="m_gelarB"></div>
           <div><label>JK</label><select id="m_jk"><option>Laki-laki</option><option>Perempuan</option></select></div>
           
           <div><label>Agama</label>
            <select id="m_agama">
                <option value="">- Pilih -</option>
                <option>Islam</option><option>Kristen</option><option>Katolik</option>
                <option>Hindu</option><option>Buddha</option><option>Konghucu</option><option>Lainnya</option>
            </select>
           </div>

           <div><label>HP/WA</label><input type="text" id="m_hp"></div>
           <div><label>Email</label><input type="email" id="m_email"></div>
           <div><label>Tmpt Lhr</label><input type="text" id="m_tmpLahir" placeholder="Isi tempat lahir sesuai KTP"></div>
           <div><label>Tgl Lahir</label><input type="date" id="m_tglLahir" onchange="updateStatusAuto()"></div>
           <div><label>Pass</label>
  <div style="position:relative;">
    <input type="password" id="m_pass" style="width:100%; padding-right:35px;">
    <i class="fa fa-eye" onclick="togglePassVisibility('m_pass', this)" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#64748b; font-size:14px;"></i>
  </div>
</div>
           
           <div><label>Pend. Terakhir</label>
             <select id="m_pend">
               <option value="">- Pilih -</option>
               <option>SD/Sederajat</option><option>SLTP/Sederajat</option><option>SLTA/Sederajat</option>
               <option>D.II</option><option>D.III</option><option>S1/D.IV</option><option>S2</option><option>S3</option>
             </select>
           </div>
           
           <div class="full-w"><label>Alamat</label><textarea id="m_alamat" rows="2" placeholder="Isi alamat lengkap"></textarea></div>
        </div>
        <h4 style="color:#4f46e5;border-bottom:1px solid #eee;margin:20px 0 15px">Instansi & Wilayah</h4>
        <div class="form-grid">
           <div><label>Unit Kerja</label><input type="text" id="m_unit" placeholder="contoh : SMAN.../SMKN..../SMPN..../SDN......."></div>
           <div><label>Jabatan</label><input type="text" id="m_jabatan" placeholder="contoh : Kepala TU/Staf TU/Arsiparis/Satpam/Petugas Kebersihan, dll"></div>
           <div><label>Sts Pegawai</label><select id="m_statPeg"><option>PNS</option><option>PPPK</option><option>PPPK-PW</option><option>Kontrak</option><option>Honorer</option></select></div>
           <div><label>Sts Sekolah</label><select id="m_statSek"><option>Negeri</option><option>Swasta</option></select></div>
           <div><label>Jenjang Sekolah</label><select id="m_jenjang"><option>TK/PAUD</option><option>SD</option><option>SLTP</option><option>SLTA</option></select></div>
           <div><label>Mulai Tugas </label><input type="date" id="m_mulai"></div>
           <div><label>Provinsi</label><select id="m_prov" onchange="loadRegencies(this.value, 'm_kab')"></select></div><div><label>Kab/Kota tempat kerja</label><select id="m_kab"></select></div>
        </div>
        <h4 style="color:#4f46e5;border-bottom:1px solid #eee;margin:20px 0 15px">Org & File</h4>
        <div class="form-grid">
           <div><label>Status</label>
             <select id="m_status" onchange="manualStatusChange()">
               <option value="BELUM AKTIF">BELUM AKTIF</option>
               <option value="AKTIF">AKTIF</option>
               <option value="NONAKTIF/MUTASI">NONAKTIF/MUTASI</option>
               <option value="PENSIUN">PENSIUN</option>
             </select>
           </div>
           
           <div><label>Jabatan Org (AH)</label>
             <select id="m_jabOrg">
               <option value="">- Pilih -</option>
               <option>Ketua Umum</option><option>Sekretaris Jenderal</option><option>Bendahara Umum</option>
               <option>Ketua</option><option>Sekretaris</option><option>Bendahara</option>
               <option>Anggota Pengurus</option><option>Anggota Biasa</option>
               <option>Dewan Pembina</option><option>Dewan Pakar</option><option>Dewan Penasehat</option>
             </select>
           </div>
           <div><label>Tingkat Pengurus(AI)</label>
             <select id="m_tingkat">
               <option value="">- Pilih -</option>
               <option>Pusat</option><option>Daerah/Provinsi</option><option>Cabang/Kab-Kota</option>
             </select>
           </div>
           <div><label>Masa KTA (AK)</label><input type="date" id="m_masaKta" readonly style="background:#f3f4f6"></div>
           <div class="full-w"><label>Link KTA (PDF)</label><input type="text" id="m_linkKta" placeholder="Kosongkan jika tidak ada"></div>
           <div class="full-w">
                <label>Foto Anggota (3:4)</label>
                <input type="file" id="m_file_input" onchange="handleManualCrop(event, 'm_crop_area', 'm_preview_final')" accept="image/*">
                <input type="hidden" id="m_base64"> <div id="m_crop_container" style="display:none; margin-top:10px; background:#f0f0f0; padding:10px; border-radius:10px;">
                    <div id="m_crop_area"></div>
                <button type="button" class="btn btn-sm btn-green" onclick="executeCrop('m_crop_area', 'm_base64', 'm_crop_container', 'm_preview_final')" style="width:100%; margin-top:5px">Kunci Foto</button>
               </div>
                <div id="m_preview_final" style="margin-top:10px; text-align:center"></div>
            </div></div>

        
        <div style="margin-top:20px; display:flex; justify-content:space-between">
           <button type="button" class="btn btn-red" onclick="resetPass()">Reset Password</button>
           <button type="submit" class="btn btn-green">SIMPAN DATA</button>
        </div>
      </form>
    </div>
  </div>

  <div id="adminProfileModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <h3>Edit Profil Admin</h3>
      <form onsubmit="handleAdminProfileSave(event)">
         <input type="hidden" id="adm_row">
         <div style="margin-bottom:10px">
           <label>Nama Lengkap</label>
           <input type="text" id="adm_name" required style="width:100%">
         </div>
         <div style="margin-bottom:10px">
           <label>Username</label>
           <input type="text" id="adm_user" required style="width:100%">
         </div>
         <div style="margin-bottom:10px">
           <label>Password</label>
           <div style="position:relative;">
  <input type="password" id="adm_pass" required style="width:100%; padding-right:40px;">
  <i class="fa fa-eye" onclick="togglePassVisibility('adm_pass', this)" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); cursor:pointer; color:#64748b;"></i>
</div>
         </div>
         <button type="submit" class="btn btn-primary" style="width:100%;margin-top:15px">Simpan Perubahan</button>
      </form>
      <button onclick="closeModal('adminProfileModal')" class="btn btn-outline" style="width:100%;margin-top:10px">Batal</button>
    </div>
  </div>

  <div id="detailModal" class="modal">
    <div class="modal-content" style="max-width:550px">
      <div style="display:flex;justify-content:space-between;margin-bottom:15px">
         <h3 style="color:#4f46e5">Detail Anggota</h3>
         <button onclick="closeModal('detailModal')" style="border:none;background:none;color:red;font-size:24px">&times;</button>
      </div>
      <div style="text-align:center;margin-bottom:20px">
         <img id="dFoto" src="" style="width:120px;height:120px;border-radius:50%;border:4px solid #eee;object-fit:cover">
         <h3 id="dName" style="margin-top:10px"></h3>
         <p id="dJob" style="color:#64748b"></p>
         <span id="dStatus" style="display:inline-block;margin-top:5px;padding:3px 10px;background:#dcfce7;color:#16a34a;border-radius:15px;font-size:11px;font-weight:700"></span>
      </div>
      <div id="dContent" style="padding:15px;background:#f9fafb;border-radius:12px;border:1px solid #eee"></div>
      <div id="dAction" style="margin-top:20px;text-align:center"></div>
      
      <!-- <button class="btn btn-orange" onclick="checkAndOpenKta(currentDetailMember)" style="width:100%;margin-top:10px">Lihat KTA Digital</button> -->
      <button class="btn btn-outline" onclick="checkAndDownloadBg(currentDetailMember)" style="width:100%;margin-top:10px; border-style:dashed; color:#4f46e5"><i class="fa fa-image"></i> Unduh KTA Belakang (PNG)</button>
    </div>
  </div>

  <div id="selfEditModal" class="modal">
    <div class="modal-content" style="max-width:550px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
         <h3>Edit Profil Saya</h3>
         <button onclick="closeModal('selfEditModal')" style="background:none; border:none; font-size:24px; color:#ef4444; cursor:pointer">&times;</button>
      </div>
      <form id="formSelf" onsubmit="handleSelfSave(event)">
        <input type="hidden" id="s_row"><input type="hidden" id="s_curFoto"><input type="hidden" id="s_base64">
        <div class="full-w" style="text-align:center;margin-bottom:15px">
            <div id="s_preview_final" style="width:120px;height:160px;border-radius:8px;background:#eee;margin:0 auto 10px;overflow:hidden;border:2px solid #ddd"></div>
          <label class="btn btn-outline btn-sm" style="cursor:pointer">Ganti Foto
            <input type="file" style="display:none" onchange="handleManualCrop(event, 's_crop_area', 's_preview_final')" accept="image/*">
            </label>
            <input type="hidden" id="s_base64">

            <div id="s_crop_container" style="display:none; margin-top:10px; background:#f8fafc; padding:10px; border-radius:10px; border:1px solid #e2e8f0">
             <div id="s_crop_area"></div>
                 <button type="button" class="btn btn-sm btn-orange" onclick="executeCrop('s_crop_area', 's_base64', 's_crop_container', 's_preview_final')" style="width:100%; margin-top:5px">Kunci Foto Baru</button>
            </div>
              </div>

        <div class="form-grid">
          <div><label>Tmpt Lhr</label><input type="text" id="s_tmpLahir" placeholder="Isi tempat lahir sesuai KTP"></div>
           <div><label>Tgl Lahir</label><input type="date" id="s_tglLahir" onchange="updateStatusAuto()"></div>
           
           <div><label>JK</label><select id="s_jk"><option>Laki-laki</option><option>Perempuan</option></select></div>
           <div><label>Agama</label>
            <select id="s_agama">
                <option value="">- Pilih -</option>
                <option>Islam</option><option>Kristen</option><option>Katolik</option>
                <option>Hindu</option><option>Buddha</option><option>Konghucu</option><option>Lainnya</option>
            </select>
           </div>

           <div><label>Pend. Terakhir</label>
             <select id="s_pend">
               <option value="">- Pilih -</option>
               <option>SD/Sederajat</option><option>SLTP/Sederajat</option><option>SLTA/Sederajat</option>
               <option>D.II</option><option>D.III</option><option>S1/D.IV</option><option>S2</option><option>S3</option>
             </select>
           </div>

           <div><label>Provinsi</label><select id="s_prov" onchange="loadRegencies(this.value, 's_kab')"></select></div>
           <div><label>Kab/Kota tempat kerja</label><select id="s_kab"></select></div>
           <div><label>Unit Kerja</label><input type="text" id="s_unit" placeholder="contoh : SMAN.../SMKN..../SMPN..../SDN......."></div>
           <div>
         <label>Status Sekolah</label>
         <select id="s_statSek" required>
        <option value="">Pilih Status</option>
        <option value="NEGERI">NEGERI</option>
        <option value="SWASTA">SWASTA</option>
         </select>
           </div>
           <div><label>Jabatan</label><input type="text" id="s_jabatan" placeholder="contoh : Kepala TU/Staf TU/Arsiparis/Satpam/Petugas Kebersihan, dll"></div>
           <div><label>Status Peg</label><select id="s_statPeg"><option>PNS</option><option>PPPK</option><option>PPPK-PW</option><option>Kontrak</option><option>Honorer</option></select></div>
           <div><label>Jenjang Sklh</label><select id="s_jenjang"><option>TK/PAUD</option><option>SD</option><option>SLTP</option><option>SLTA</option></select></div>
           <div><label>Mulai Tugas</label><input type="date" id="s_mulai"></div>
           <div><label>HP/WA</label><input type="text" id="s_hp"></div>
           <div><label>Email</label><input type="email" id="s_email"></div>
           
            <div class="full-w"><label>Alamat</label><textarea id="s_alamat" rows="2" placeholder="Isi alamat lengkap"></textarea></div>
        </div>
        <button type="submit" class="btn btn-orange" style="width:100%; margin-top:20px">Update Profil</button>
      </form>
    </div>
  </div>
  
  <div id="passModal" class="modal">
    <div class="modal-content" style="max-width:400px">
      <h3>Ganti Password</h3>
     <form onsubmit="handlePassChange(event)">
   <div style="position:relative; margin-bottom:10px;">
       <input type="password" id="cp_old" placeholder="Password Lama" required style="width:100%; padding-right:40px;">
       <i class="fa fa-eye" onclick="togglePassVisibility('cp_old', this)" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); cursor:pointer; color:#64748b;"></i>
   </div>
   <div style="position:relative; margin-bottom:10px;">
       <input type="password" id="cp_new" placeholder="Password Baru" required style="width:100%; padding-right:40px;">
       <i class="fa fa-eye" onclick="togglePassVisibility('cp_new', this)" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); cursor:pointer; color:#64748b;"></i>
   </div>
   <button type="submit" class="btn btn-primary" style="width:100%;margin-top:15px">Simpan</button>
</form>
      <button onclick="closeModal('passModal')" class="btn btn-outline" style="width:100%;margin-top:10px">Batal</button>
    </div>
  </div>
  
  <div id="ktaGenModal" class="modal">
    <div class="modal-content" style="max-width:450px;text-align:center">
       <h3>Unduh KTA Digital</h3> <br>
       <canvas id="ktaCanvas" width="600" height="380" style="display:block;width:100%;max-width:100%;height:auto;border-radius:10px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,0.2)"></canvas>
       <a id="downloadKtaBtn" class="btn btn-primary" download="KTA_Digital.png">Unduh Gambar (PNG)</a>
       <button onclick="closeModal('ktaGenModal')" class="btn btn-outline" style="margin-top:10px">Tutup</button>
    </div>
  </div>
  
   <div id="regModal" class="modal">
  <div class="modal-content" style="max-width:600px">
    
    <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px">
        <h3 style="color:#4f46e5; margin:0 0 5px 0">Formulir Pendaftaran Anggota</h3>
        
        <h4 id="lblRegOrg" style="margin:0; font-weight:700; color:#333; font-size:16px">Loading...</h4>
        
        <p id="lblRegProv" style="margin:0; color:#64748b; font-size:13px">Loading...</p>
    </div>
    <form id="formReg" onsubmit="handleRegistration(event)">
      <div class="form-grid">
        <div class="full-w"><label>NIK (16 Digit)</label><input type="text" id="r_nik" required oninput="sanitizeNumber(this)" maxlength="16" placeholder="16 Digit Angka"></div>
        <div class="full-w"><label>Nama Lengkap (Tanpa Gelar)</label><input type="text" id="r_nama" placeholder="Isi nama sesuai KTP" required></div>
        <div><label>Tempat Lahir</label><input type="text" id="r_tmp" placeholder="Isi Tempat lahir sesuai KTP" required></div>
        <div><label>Tanggal Lahir</label><input type="date" id="r_tgl" required></div>
        <div><label>Jenis Kelamin</label><select id="r_jk"><option>Laki-laki</option><option>Perempuan</option></select></div>
        
        <div><label>Agama</label>
            <select id="r_agama" required>
                <option value="">- Pilih -</option>
                <option>Islam</option><option>Kristen</option><option>Katolik</option>
                <option>Hindu</option><option>Buddha</option><option>Konghucu</option><option>Lainnya</option>
            </select>
        </div>

       <div><label>HP/WhatsApp</label><input type="text" id="r_hp" required></div>

<div><label>Email (Aktif)</label><input type="email" id="r_email" placeholder="email@contoh.com" required></div>

<div><label>Unit Kerja</label><input type="text" id="r_unit" placeholder="contoh : SMAN 1...." required></div>
<div>
    <label>Status Sekolah</label>
    <select id="r_statSek" required>
        <option value="">Pilih Status</option>
        <option value="NEGERI">NEGERI</option>
        <option value="SWASTA">SWASTA</option>
    </select>
</div>
<div><label>Jabatan</label><input type="text" id="r_jab" placeholder="contoh : Kepala Tu/Staf/Operator/dll." required></div>

<div><label>Status Pegawai</label><select id="r_statPeg"><option>PNS</option><option>PPPK</option><option>PPPK-PW</option><option>Kontrak</option><option>Honorer</option></select></div>

<div><label>Pendidikan Terakhir</label>
    <select id="r_pend" required>
        <option value="">- Pilih -</option>
        <option>SD/Sederajat</option>
        <option>SLTP/Sederajat</option>
        <option>SLTA/Sederajat</option>
        <option>D.II</option>
        <option>D.III</option>
        <option>S1/D.IV</option>
        <option>S2</option>
        <option>S3</option>
    </select>
</div>

<div class="full-w">
    <label>Alamat Lengkap (Jalan, RT/RW, Desa/Kelurahan)</label>
    <textarea id="r_alamat" rows="2" placeholder="Isi alamat domisili lengkap" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px"></textarea>
</div>
        
        <div class="full-w">
          <label>Provinsi</label>
          <select id="r_prov" onchange="loadRegencies(this.value, 'r_kab')" required></select> 
        </div>
        <div class="full-w">
          <label>Kab/Kota tempat kerja</label>
          <select id="r_kab" required><option value="">Pilih Provinsi Dahulu</option></select>
        </div>

        <div class="full-w">
          <label>Pas Foto (Otomatis Crop 3:4)</label>
          <input type="file" id="r_file" accept="image/*" onchange="handleFileAndCrop(event)" required>
          <input type="hidden" id="r_base64">
          <div id="r_preview" style="margin-top:10px; text-align:center"></div>
        </div>

<div id="r_preview_container" style="display:none; margin-top:10px;">
    <div id="crop_area"></div>
    <button type="button" class="btn btn-sm btn-green" onclick="saveCrop()" style="width:100%; margin-top:5px">Kunci Foto (Selesai Crop)</button>
</div>
<div id="final_preview_container" style="margin-top:10px; text-align:center"></div>

      </div>
      <div><br></div>
      <div style="display:flex; gap:10px; margin-top:25px">
    <button type="button" class="btn btn-red" onclick="closeModal('regModal')" style="flex:1">
        <i class="fa fa-times"></i> BATAL
    </button>
    
    <button type="submit" class="btn btn-primary" style="flex:2">
        <i class="fa fa-paper-plane"></i> KIRIM PENDAFTARAN
    </button>
</div>
    </form>
  </div>
</div>

<script>
// ====================================================================
// ðŸš€ 1. KONFIGURASI DATABASE CABANG (KAMUS API)
// ====================================================================
const LIST_DATABASE = {
"01aceh": "https://script.google.com/macros/s/AKfycbxU1nIEiR-UvYKzM39Gew7fbLD6bE1Zh8Pj9BFbp87iuUWxSN_m1s2Z-3j7l-nbFIQB/exec",
"02sumaterautara": "https://script.google.com/macros/s/AKfycbyq047uQbgQx9zktEjo37ITnjAFAitcqF8nOkCTrBqYQwlyGlcg1ZXz0zb4Hnq_l5V3ZA/exec",
"03sumateraselatan": "https://script.google.com/macros/s/AKfycbxkcJpMCgBE-95dUMp7Eaoalk4I94qpofy8ia76akAlANc86cw3yWp089ivvydNqG5aJQ/exec",
"04sumaterabarat": "https://script.google.com/macros/s/AKfycbzWu39gCEUok1LDd8ItAZlIGAz3-xDQ358hqDdquEjHmHDr7SXgOvRM3YDiTeu0aVNo/exec",
"05bengkulu": "https://script.google.com/macros/s/AKfycbzB-PZA2-VnoyaG89VQ_D0peIgBBHwJrUegzmVFdyG70Ee-3cAWKLV0CCHFSVjl1c7A/exec",
"06riau": "https://script.google.com/macros/s/AKfycbxCIp5Tw3mGkEg_UZUCKk4y1W9j1wuu3Re-XHrn50BGNC2kMwi7WERDr-I4j1RfiIY5/exec",
"07kepulauanriau": "https://script.google.com/macros/s/AKfycbw-n8OOIu7RV5X4E2Dfjk7o3fqeCfqMbKliyiQA2SqymidiAImc6iWh9qp9E0zoH5zW/exec",
"08jambi": "https://script.google.com/macros/s/AKfycbyqe5dI9KvrpE1xpfbLfdkFq9xvZa8JjHUrsShCrxhS2MUFaREMbDgTZ24q_ASlYJQw/exec",
"09lampung": "https://script.google.com/macros/s/AKfycby4DZStgcD25_Es0026ZK-y_h4Kqu9GRK2znl1VQzMN5h_tuynR18T76ZKb6BofhZiuIg/exec",
"10kepulauanbangkabelitung": "https://script.google.com/macros/s/AKfycbxdnhqZwhT8aaLBrlhUnw5U7fL1024sN34ItJ8qzYiCo30uWnJJqvDF4f1rsBBh7Z0bMQ/exec",
"11banten": "https://script.google.com/macros/s/AKfycbzb58JfEe1bwWqeZCeWqgroriJ9RlA8QXvxkw0ISlA6LdyrQTmitbC2OBYLaVZY1Lft3g/exec",
"12dkijakarta": "https://script.google.com/macros/s/AKfycbyCvnbmWcurDR8HDMutidy6Zfp6esV3XNgS8S_mV6FmQOHsDDPbZ7jB5d1pL02Nuhcv/exec",
"13jawabarat": "https://script.google.com/macros/s/AKfycbxFv9NKx_6-1rKmqqMA9ugG9OBPbbe-0h-wKapWedtiE036spLNsmLrVUxKfv44QpQ/exec",
"14jawatengah": "https://script.google.com/macros/s/AKfycbyHAihR-6lMrmYjvRokLchDgwPO-m_FS6wYx2CRNi8fKjXUUbr9X1qIz_W3yksikVuZ/exec",
"15diyogyakarta": "https://script.google.com/macros/s/AKfycbxqk5rrYCqDdnFUovZTnZEjtTDh5S965rjOGeS1-gi-zyfK5tw6vwMpYVmVaAuLz4aN/exec",
"16jawatimur": "https://script.google.com/macros/s/AKfycbzvwdYy_280tVzgsyxnxbMjyVpdR_dVZa8XgXavasWjpJl9jZDpF_3v1vYPX5TcjVf1/exec",
"17kalimantantimur": "https://script.google.com/macros/s/AKfycbyJBXWPUGhBmRxBrpFPsekDp01kX2jNNsQC1zrQERNQKz4PGwjBBonyCNBxV3EzMC2IOg/exec",
"18kalimantanbarat": "https://script.google.com/macros/s/AKfycbyuRVK2nd45oyyw6uWp6x7pIAspb7LcPuRNxGRHGJLZN9mnKLThO-SQs2vg5HUMLjRz/exec",
"19kalimantantengah": "https://script.google.com/macros/s/AKfycbzuzPHdHHj1WiLClmb1WCgF3QsPS5KzovEiEVPQVWGFeKiTmzKBrZKM8fjXWgJQlehj/exec",
"20kalimantanselatan": "https://script.google.com/macros/s/AKfycbzjzo1d4T8oCiQfO2apgPkIA4dVcVNoSVQaS_LIHQCzdWdvBx4oQw9985sf6WIOtTfcNg/exec",
"21kalimantanutara": "https://script.google.com/macros/s/AKfycby1WuXMkVxNpYH9GaGQvpB8efkADl_1h9p43BffbAE0irWOCPpv9sIjN2ZQrijREvPO/exec",
"22bali": "https://script.google.com/macros/s/AKfycbxA70IT-Lpu476eBG3AUEDbzZfXDX7BnWSNHn-sB30EhTG38qTZw5ZeuNdxMgwhZU0R/exec",
"23nusatenggaratimur": "https://script.google.com/macros/s/AKfycbz3YVIZ2p6CcK30Z3w4r-glG6albTS0pDChKj6ZGSwfozZTzedtCSuMe0cFae4yofPFHg/exec",
"24nusatenggarabarat": "https://script.google.com/macros/s/AKfycbyVUbIwscjQGKQylvo9mpv_ls4v81ZyvVv72LYu3xEdFbuYAHTomq2xJ73AxF8th5_rhQ/exec",
"25gorontalo": "https://script.google.com/macros/s/AKfycbyD8tIEVPjHP6dysG7Y43CxvnCTUXe6JY0yAVwp3o4w_D-67rADiy04zRXDLL7jCA9jTA/exec",
"26sulawesibarat": "https://script.google.com/macros/s/AKfycbwGRyKr_wvTGJZaGpfRZKTUBmlyg15-o0RvuYv-GtLLVUZys6bV9o0Gl3UjGc-oXRgI/exec",
"27sulawesitengah": "https://script.google.com/macros/s/AKfycbxWunpQNbWzK6A5Jq_DQAZ9-p3oAzPxD385e0tQQYPHbgM8l0A-tBjqEx83HjMmIwFL7Q/exec",
"28sulawesiutara": "https://script.google.com/macros/s/AKfycbwZeaQwrJQRD2XhY0MDiQJY4kiv7Ea4-GNhPO5DC1AULCWhF21-LvZaWKxSgRemEiHf/exec",
"29sulawesitenggara": "https://script.google.com/macros/s/AKfycbywLulujYkRhBlJD3riFMqejfShpj-iCHupEThAa6Rg-zGlZ0PYyEd8b4G0G5_crjTy/exec",
"30sulawesiselatan": "https://script.google.com/macros/s/AKfycbyblFxymyR5W2YqZAdB3r46vMBdzd_EEFs2E9r-DhRNky2Cjo3NW1YDCdKnbhOUfS0/exec",
"31malukuutara": "https://script.google.com/macros/s/AKfycbzK7UuPVxB7ouvfNVbz3oPbMGASjspRlJuFA-H6er2xjsq5g14i81yIbPGlqlRGjP_0WA/exec",
"32maluku": "https://script.google.com/macros/s/AKfycbzGJaJLZYGE5zEKBbIHnKuzjPOHQYXw7dO00vNUN1DZ1EM10oCbL3hIpAQuVMG1P--UzA/exec",
"33papuabarat": "https://script.google.com/macros/s/AKfycbxLNkxDYzKwszSthPNXoSSMxdVu3VKF4iBkYVRIbIYIrhNHmySnA38swUr7tY8pN2kcgA/exec",
"34papua": "https://script.google.com/macros/s/AKfycby0lz8CrvmIOeHZZZtlByQIwcKFjVmVq_8BRrXvY1gI9u2QVqtkAPLFhUNWrZc0m1GLEA/exec",
"35papuaselatan": "https://script.google.com/macros/s/AKfyc...A/exec",
"36papuatengah": "https://script.google.com/macros/s/AKfyc...A/exec",
"37papuapegunungan": "https://script.google.com/macros/s/AKfyc...A/exec",
"38papuabaratdaya": "https://script.google.com/macros/s/AKfyc...A/exec",
};

// Baca parameter dari URL browser (contoh: web.com/?id=cabangA)
const urlParams = new URLSearchParams(window.location.search);
const dbId = urlParams.get('id') || "default"; 
const API_URL = LIST_DATABASE[dbId];

if (!API_URL) {
    alert("Akses Ditolak: URL Database tidak ditemukan atau parameter ?id salah.");
}

// ðŸš€ FUNGSI SAKTI PENGGANTI google.script.run
async function apiCall(actionName, dataObj = {}) {
    try {
        let response = await fetch(API_URL, {
            method: 'POST',
            redirect: 'follow', // Penting agar Google Script tidak memblokir
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Wajib text/plain untuk bypass CORS
            body: JSON.stringify({ action: actionName, data: dataObj })
        });
        
        let result = await response.json();
        if (result.status === "error") throw new Error(result.message);
        
        return result.data; // Mengembalikan persis seperti format google.script.run
    } catch (error) {
        console.error("API Error (" + actionName + "):", error);
        throw error;
    }
}
// ====================================================================


// --- 2. GLOBAL VARIABLES & HELPERS ---
var appData = { settings: null, user: null, members: [] };
var adminState = { page: 1, limit: 10, search: "", fUnit: "", fStatus: "", fKab: "", totalData: 0 };
var croppieInstance = null;
var activeCroppie = null; 
var currentDetailMember = null;
var chartInstance = null;
var currentSearchMode = 'nik';
var tableLoaderInterval = null;

var scrollBtn = document.getElementById("scrollTopBtn");
window.onscroll = function() { 
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) { 
        if(scrollBtn) scrollBtn.style.display = "block"; 
    } else { 
        if(scrollBtn) scrollBtn.style.display = "none"; 
    } 
};

function scrollToTop() { document.body.scrollTop = 0; document.documentElement.scrollTop = 0; }

var loaderInterval = null;
function showLoader(show, customText) { 
    var l = document.getElementById('loader'); 
    if(!l) return;
    var p = l.querySelector('p');
    if(!p) return;
    
    p.style.textAlign = "center";
    p.style.lineHeight = "1.5";

    if(show) {
        l.classList.remove('hidden');
        var timer = 5; 
        var baseText = customText || 'MEMUAT...';
        p.innerHTML = baseText + '<br><span style="font-size:24px; color:#ef4444; font-weight:800; display:block; margin-top:5px;">' + timer + '</span>';
        
        clearInterval(loaderInterval);
        loaderInterval = setInterval(function() {
            timer--;
            if(timer > 0) {
                p.innerHTML = baseText + '<br><span style="font-size:24px; color:#ef4444; font-weight:800; display:block; margin-top:5px;">' + timer + '</span>';
            } else {
                clearInterval(loaderInterval);
                p.innerHTML = 'Data sedang diproses, mohon tunggu...<br><span style="font-size:12px; color:#666; font-weight:normal;">(Server sedang memuat...)</span>';
            }
        }, 1000); 
    } else {
        clearInterval(loaderInterval);
        l.classList.add('hidden');
        p.innerHTML = 'MEMUAT...'; 
    }
}

function notify(icon, title, text) { Swal.fire({ icon: icon, title: title, text: text, showConfirmButton: false, timer: 2000, toast: true, position: 'top-end' }); }

function getImageUrl(url) { 
    if(!url || typeof url !== 'string' || url.length < 5) return 'https://via.placeholder.com/150?text=NO+IMG'; 
    if(url.startsWith('data:image')) return url;
    var id = ""; var m1 = url.match(/id=([^&]+)/); var m2 = url.match(/\/d\/([^/]+)/);
    if (m1) id = m1[1]; else if (m2) id = m2[1];
    if (id) return 'https://lh3.googleusercontent.com/d/' + id; 
    return url; 
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
function openModal(id){ document.getElementById(id).classList.add('active'); }

// --- 3. STARTUP (AUTO-LOGIN) ---
window.onload = function() { 
    var safetyTimer = setTimeout(function() {
        var l = document.getElementById('loader');
        if(l && !l.classList.contains('hidden')) { showLoader(false); if(document.getElementById('app').innerHTML === "") { appData.settings = {nama: 'Aplikasi Keanggotaan', singkatan: 'APP', logo:''}; renderLogin(); } }
    }, 8000); 

    var savedSession = localStorage.getItem('atas_session');
    
    // FETCH SETTINGS VIA API
    apiCall('getSettings').then(function(s) {
        clearTimeout(safetyTimer); appData.settings = s; showLoader(false); document.getElementById('app').className = ""; loadProvinces(); 
        
        if (savedSession) { 
            try { 
                var tempUser = JSON.parse(savedSession); 
                var userIdentifier = tempUser.data.username || tempUser.data.id;
                
                showLoader(true);
                // FETCH LOGIN VIA API
                apiCall('loginUser', { username: userIdentifier, password: tempUser.data.password }).then(function(res) {
                    showLoader(false);
                    if(res.status === 'success') {
                        appData.user = res;
                        localStorage.setItem('atas_session', JSON.stringify(res));
                        res.role.includes('admin') ? renderAdmin() : renderMember();
                    } else {
                        localStorage.removeItem('atas_session');
                        renderLogin();
                    }
                }).catch(function() { showLoader(false); renderLogin(); });
                
            } catch(e) { 
                localStorage.removeItem('atas_session'); renderLogin(); 
            } 
        } else { 
            renderLogin(); 
        } 
    }).catch(function(err){ 
        clearTimeout(safetyTimer); showLoader(false); alert("Gagal koneksi API. Coba refresh."); 
    });
};

// --- 4. RENDER FUNCTIONS ---
function renderLogin() {
  var overlay = document.getElementById('sidebarOverlay'); if(overlay) overlay.remove(); 
  var btnRef = document.querySelector('.btn-refresh-float'); if(btnRef) btnRef.style.display = 'none';
  var s = appData.settings || {nama:'Loading...', singkatan:'APP', logo:''};
  var cleanLogo = getImageUrl(s.logo);
  var html = '<div class="login-body"><div class="marquee-bar"><marquee>ðŸ“¢ '+ (s.running||'Selamat Datang') +'</marquee></div>';
  html += '<div class="glass-card"><img src="'+cleanLogo+'" class="logo-anim" onerror="this.src=\'https://via.placeholder.com/100?text=LOGO\';">';
  html += '<h3>'+s.singkatan+'</h3><p style="color:var(--text-gray);margin-bottom:25px">'+s.nama+'<br>'+(s.provinsi_default||'')+'</p>';
  html += '<form onsubmit="doLogin(event)"><input type="text" id="u" placeholder="Username/NIA" required>';
  html += '<div style="position:relative; margin-top:10px;"><input type="password" id="p" placeholder="Password" required style="padding-right:45px;"><i class="fa fa-eye" id="togglePass" onclick="togglePasswordLogin()" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); cursor:pointer; color:#64748b; font-size:18px;"></i></div>';
  html += '<button type="submit" class="btn-glow">MASUK</button><div style="margin-top:15px; text-align:center;"><a onclick="showForgotInfo()" style="color:#ef4444;font-size:12px;font-weight:600;cursor:pointer;text-decoration:underline;">Lupa Password?</a></div></form>';

  html += '<div class="desktop-login-actions">'; 
  html += '<button onclick="openSearchModal()" class="btn btn-green" style="width:100%;margin-top:10px;justify-content:center;border-color:rgba(255,255,255,0.3);color:white"><i class="fa fa-search"></i> Cek Data Anggota</button>';
  html += '<button onclick="openRegistrationModal()" class="btn btn-orange" style="width:100%;margin-top:10px;justify-content:center;"><i class="fa fa-user-plus"></i> Isi Formulir Pendaftaran</button>';
  html += '<div class="contact-icons" style="text-align:center"><p style="font-size:11px; margin-bottom:5px; font-weight:bold; color:#666">Contact Center :</p>';
  if(s.wa) html += '<a href="https://wa.me/'+s.hp+'" target="_blank" class="c-icon"><i class="fab fa-whatsapp"></i></a>';
  if(s.hp) html += '<a href="tel:'+s.hp+'" class="c-icon"><i class="fa fa-phone"></i></a>';
  if(s.web) html += '<a href="'+(s.web.startsWith('http')?s.web:'http://'+s.web)+'" target="_blank" class="c-icon"><i class="fa fa-globe"></i></a>';
  if(s.email) html += '<a href="mailto:'+s.email+'" class="c-icon"><i class="fa fa-envelope"></i></a>';
  html += '</div></div>';

  html += '</div><div style="color:white;opacity:0.9;margin-top:auto;padding:20px;text-align:center;font-size:12px;line-height:1.6">Â© '+new Date().getFullYear()+' '+s.nama+'<br><a onclick="showPrivacyPolicy()" style="color:white;text-decoration:underline;cursor:pointer;font-weight:600">Kebijakan Privasi</a> â€¢ Hak Cipta Dilindungi.<br><div style="margin-top:11px;font-size:11px;opacity:0.7">Created with <i class="fa fa-heart" style="color:pink"></i> by <a href="https://www.fary-edtech.my.id/" target="_blank" style="color:white;text-decoration:none;font-weight:bold;border-bottom:1px dotted white">Fary EdTech</a></div></div></div>';

  html += '<div class="login-bottom-bar">';
  html += '<a href="https://www.kta-atasindonesia.or.id" target="_blank" class="nav-item"><i class="fa fa-home"></i><span>Home</span></a>';
  html += '<a onclick="openRegistrationModal()" class="nav-item"><i class="fa fa-file-alt"></i><span>Daftar</span></a>';
  html += '<a onclick="openSearchModal()" class="nav-item"><i class="fa fa-search"></i><span>Cek Anggota</span></a>';
  html += '<a onclick="openContactPopup()" class="nav-item"><i class="fa fa-headset"></i><span>Helpdesk</span></a>';
  html += '</div>';

  document.getElementById('app').innerHTML = html;
}

function renderAdmin() {
   var btnRef = document.querySelector('.btn-refresh-float'); if(btnRef) btnRef.style.display = 'flex';
   var s = appData.settings; var u = appData.user; var isSuper = (u.role === 'superadmin' || u.role === 'super');
   var roleBadge = isSuper ? '<span style="background:#ffedd5;color:#c2410c;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:10px;border:1px solid #fed7aa">SUPER ADMIN</span>' : '<span style="background:#e0e7ff;color:#4338ca;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:10px">ADMIN</span>';
   var cleanLogo = getImageUrl(s.logo);

   var mobileUIAdmin = '<div class="mobile-header"><div class="mobile-header-left"><img src="'+cleanLogo+'" onerror="this.src=\'https://via.placeholder.com/100?text=LOGO\';"><div><h3 style="margin:0; font-size:18px;">'+s.singkatan+'</h3></div></div><div class="mobile-header-right">'+(isSuper ? '<span style="color:#c2410c;font-weight:800;font-size:11px;">SUPER ADMIN</span>' : '<span style="color:#4338ca;font-weight:800;font-size:11px;">ADMIN</span>')+'</div></div>';
   mobileUIAdmin += '<div class="mobile-bottom-bar"><a class="nav-item" onclick="switchTab(\'data\')"><i class="fa fa-users"></i><span>Anggota</span></a><a class="nav-item" onclick="openAdminProfile()"><i class="fa fa-user-circle"></i><span>Profil</span></a><a class="nav-item-center" onclick="switchTab(\'dash\')"><i class="fa fa-home"></i></a><a class="nav-item" href="'+(s.hp ? 'https://wa.me/'+s.hp : '#')+'" target="_blank"><i class="fa fa-comments"></i><span>Chat Pusat</span></a><a class="nav-item" onclick="doLogout()"><i class="fa fa-sign-out-alt"></i><span>Keluar</span></a></div>';

   var html = '<div class="dashboard-layout"><div class="sidebar"><div class="sidebar-head"><h3>ADMIN PANEL</h3></div><div class="menu">';
   html += '<a class="menu-item active" id="mDash" onclick="switchTab(\'dash\')"><i class="fa fa-home"></i> Beranda</a>';
   html += '<a class="menu-item" id="mData" onclick="switchTab(\'data\')"><i class="fa fa-users"></i> Data Anggota</a>';
   if(isSuper) html += '<a class="menu-item" id="mSet" onclick="switchTab(\'setting\')"><i class="fa fa-cogs"></i> Pengaturan</a>';
   html += '<a onclick="openAdminProfile()" class="menu-item"><i class="fa fa-user-circle"></i> Profil Saya</a>';
   html += '<a onclick="doLogout()" class="menu-item" style="color:#ef4444;margin-top:20px"><i class="fa fa-sign-out-alt"></i> Logout</a></div></div>';
   
   html += '<div class="main">' + mobileUIAdmin + '<div class="content">';
   html += '<div class="admin-header"><button onclick="toggleSidebar()" class="btn btn-outline mobile-menu-btn"><i class="fa fa-bars"></i></button>'; 
   html += '<div class="org-branding" style="display:flex;align-items:center;gap:15px"><img src="'+cleanLogo+'" onerror="this.src=\'https://via.placeholder.com/100?text=LOGO\';" style="height:50px;width:auto;object-fit:contain"><div><h2 style="font-weight:700">'+s.singkatan+'</h2><div style="display:flex;align-items:center"><p style="color:var(--text-gray)">'+s.nama+'</p>'+roleBadge+'</div></div></div>';
   if(s.hp) html += '<a href="https://wa.me/'+s.hp+'" target="_blank" class="btn btn-outline admin-contact-btn"><i class="fab fa-whatsapp"></i> Chat Pusat</a>';
   html += '</div>';

   html += '<div id="viewDash"><div class="stat-row">';
   html += '<div class="stat-box"><div class="stat-icon c-blue"><i class="fa fa-users"></i></div><div><small>Total Anggota</small><h2 id="stTot">...</h2></div></div>';
   html += '<div class="stat-box"><div class="stat-icon c-green"><i class="fa fa-check-circle"></i></div><div><small>Aktif</small><h2 id="stAct">...</h2></div></div>';
   html += '<div class="stat-box"><div class="stat-icon c-orange"><i class="fa fa-clock"></i></div><div><small>Belum Aktif</small><h2 id="stBelum">...</h2></div></div>';
   html += '</div><div class="card"><h3>Sebaran Wilayah</h3><div style="height:300px"><canvas id="cityChart"></canvas></div></div></div>';
   
   html += '<div id="viewData" class="hidden"><div style="display:flex;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px"><h2>Data Anggota</h2><div><button class="btn btn-outline" onclick="exportExcel()" style="margin-right:5px"><i class="fa fa-file-excel"></i> Export (Sesuai Filter)</button><button class="btn btn-primary" onclick="openAdminModal()">+ Tambah</button></div></div>';
   html += '<div class="filters"><input type="text" placeholder="Cari Nama/NIK..." onkeyup="handleSearch()" id="sKey"><select id="fUnit" onchange="handleSearch()"><option value="">Semua Unit</option></select><select id="fKab" onchange="handleSearch()"><option value="">Semua Wilayah</option></select><select id="fStatus" onchange="handleSearch()"><option value="">Semua Status</option><option value="AKTIF">AKTIF</option><option value="BELUM AKTIF">BELUM AKTIF</option><option value="PENSIUN">PENSIUN</option><option value="NONAKTIF/MUTASI">NONAKTIF</option></select></div>';
   html += '<div class="table-box"><table><thead><tr><th>ID/NIA</th><th>Nama</th><th>Kab/Kota</th><th>Unit</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="tableBody"></tbody></table></div><div style="margin-top:15px;display:flex;justify-content:space-between;align-items:center"><div id="pageInfo" style="font-size:13px;color:#666"></div><div><button class="btn btn-sm btn-outline" onclick="changePage(-1)">< Prev</button> <button class="btn btn-sm btn-outline" onclick="changePage(1)">Next ></button></div></div></div>';
   
   if(isSuper) {
       html += '<div id="viewSetting" class="hidden"><div class="card" style="max-width:1000px;margin:0 auto"><h3 style="margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee"><i class="fa fa-sliders-h"></i> Pengaturan Aplikasi</h3><form onsubmit="handleSaveSetting(event)">';
       html += '<div class="form-grid"><div class="full-w"><label>Nama Organisasi</label><input type="text" id="set_nama" value="'+(s.nama||'')+'"></div><div><label>Singkatan</label><input type="text" id="set_singkatan" value="'+(s.singkatan||'')+'"></div>';
       html += '<div class="full-w"><label>Logo Organisasi</label><div style="display:flex;gap:15px;align-items:center;background:#f9fafb;padding:10px;border:1px solid #e2e8f0;border-radius:8px"><img src="'+getImageUrl(s.logo)+'" id="preview_logo_set" style="width:50px;height:50px;object-fit:contain"><input type="file" id="file_logo" accept="image/*" onchange="previewLogoSetting(event)" style="border:none;background:transparent;"><input type="hidden" id="set_logo_url" value="'+(s.logo||'')+'"></div></div>';
       html += '<div class="full-w"><label>Running Text</label><input type="text" id="set_running" value="'+(s.running||'')+'"></div><div><label>No HP</label><input type="text" id="set_hp" value="'+(s.hp||'')+'"></div><div><label>No WA</label><input type="text" id="set_wa" value="'+(s.wa||'')+'"></div><div><label>Email</label><input type="text" id="set_email" value="'+(s.email||'')+'"></div><div><label>Website</label><input type="text" id="set_web" value="'+(s.web||'')+'"></div></div>';
        // UBAH MENJADI (Kita bagi 2 grid, satu untuk Provinsi, satu untuk Nama Admin):
      html += '<div><label>Provinsi Default</label><input type="text" id="set_prov" value="'+(s.provinsi_default||'')+'"></div><div><label>Nama Admin Prov</label><input type="text" id="set_nama_admin" value="'+(s.nama_admin_prov||'')+'"></div></div>';
       html += '<button type="submit" class="btn btn-primary" style="width:100%;margin-top:20px">SIMPAN PENGATURAN</button></form></div></div>';
   }

   html += '<div style="color:#64748b;opacity:0.9;margin-top:auto;padding:20px;text-align:center;font-size:12px;line-height:1.6; border-top:1px solid #e2e8f0;">';
   html += 'Â© '+new Date().getFullYear()+' '+s.nama+'<br>';
   html += '<a onclick="showPrivacyPolicy()" style="color:#4f46e5;text-decoration:underline;cursor:pointer;font-weight:600">Kebijakan Privasi</a> â€¢ Hak Cipta Dilindungi.</div></div></div></div>';
   document.getElementById('app').innerHTML = html;
   loadData(); loadDashboardStats(); populateFilters();
}

function renderMember() {
    var btnRef = document.querySelector('.btn-refresh-float'); if(btnRef) btnRef.style.display = 'flex';
    if(!appData.user || !appData.user.data) { Swal.fire('Error Session', 'Data profil tidak lengkap. Login ulang.', 'error').then(()=> doLogout()); return; }

    var u = appData.user.data; var safe=v=>v||'-'; var s=appData.settings;
    var cleanLogo = getImageUrl(s.logo);
    
    var mobileUIMember = '<div class="mobile-header"><div class="mobile-header-left"><img src="'+cleanLogo+'" onerror="this.src=\'https://via.placeholder.com/100?text=LOGO\';"><div><h3 style="margin:0; font-size:18px;">'+s.singkatan+'</h3></div></div><div class="mobile-header-right" onclick="openChangePass()" style="cursor:pointer;"><i class="fa fa-key" style="font-size:16px; color:#4f46e5; margin-bottom:2px;"></i><span style="font-size:9px; font-weight:600; color:#64748b;">Ubah Sandi</span></div></div>';
    mobileUIMember += '<div class="mobile-bottom-bar"><a class="nav-item active" onclick="scrollToTop()"><i class="fa fa-home"></i><span>Home</span></a><a class="nav-item" onclick="openSelfEdit()"><i class="fa fa-user-edit"></i><span>Edit Profil</span></a><a class="nav-item-center" onclick="checkAndOpenKta(appData.user.data)"><i class="fa fa-id-badge" style="margin-top:4px;"></i><span>Buat KTA</span></a><a class="nav-item" onclick="openContactPopup()"><i class="fa fa-headset"></i><span>Bantuan</span></a><a class="nav-item" onclick="doLogout()"><i class="fa fa-sign-out-alt"></i><span style="font-weight:300; font-size:9px;">Keluar</span></a></div>';

    var html = '<div class="dashboard-layout"><div class="sidebar"><div class="sidebar-head"><h3>ANGGOTA</h3></div><div class="menu"><a class="menu-item active"><i class="fa fa-user"></i> Profil</a><a onclick="doLogout()" class="menu-item" style="color:red"><i class="fa fa-sign-out-alt"></i> Logout</a></div></div>';
    
    html += '<div class="main">' + mobileUIMember + '<div class="content">';
    html += '<div class="admin-header"><button onclick="toggleSidebar()" class="btn btn-outline mobile-menu-btn"><i class="fa fa-bars"></i></button><div class="org-branding" style="display:flex;align-items:center;gap:15px"><img src="'+cleanLogo+'" onerror="this.src=\'https://via.placeholder.com/100?text=LOGO\';" style="height:50px;width:auto;object-fit:contain"><div><h2 style="font-weight:700">'+s.singkatan+'</h2><p style="color:var(--text-gray)">'+s.nama+'</p></div></div>';
    html += '<div class="admin-contact-btn" style="display:flex; gap:10px;">';
    if(s.hp) html += '<a href="https://wa.me/'+s.hp+'" target="_blank" class="btn btn-outline" style="border-color:#ea580c; color:#ea580c;"><i class="fab fa-whatsapp"></i> Admin Pusat</a>';
    if(s.wa) html += '<a href="https://wa.me/'+s.wa+'" target="_blank" class="btn btn-green"><i class="fab fa-whatsapp"></i> Admin Prov</a>';
    html += '</div></div>';

    html += '<div class="card" style="padding:0;overflow:hidden;margin-bottom:30px"><div class="profile-hero"><div class="hero-avatar"><img src="'+getImageUrl(u.foto)+'" style="width:100%;height:100%;object-fit:cover;border-radius:15px"></div>';
    html += '<div class="hero-info"><div class="hero-name">'+safe(u.nama)+'</div><div class="hero-role">'+safe(u.jabatan)+' â€¢ '+safe(u.unit)+'</div></div>';
    html += '<div class="hero-actions"><button class="hero-btn" onclick="openSelfEdit()"><i class="fa fa-pencil-alt"></i> Edit Profil</button><button class="hero-btn" onclick="openChangePass()"><i class="fa fa-key"></i> Ganti Password</button></div></div>';
    
    html += '<div class="member-content-pad" style="padding:60px 30px 30px 30px"><div class="info-grid-container">';
    html += '<div class="info-card"><div class="info-header"><i class="fa fa-id-card"></i> PRIBADI</div><div class="info-body"><div class="data-row"><div class="data-label">Nama</div><div class="data-val">'+safe(u.nama)+'</div></div><div class="data-row"><div class="data-label">NIK</div><div class="data-val">'+safe(u.nik)+'</div></div><div class="data-row"><div class="data-label">TTL</div><div class="data-val">'+safe(u.tempat_lahir)+', '+safe(u.tgl_lahir)+'</div></div><div class="data-row"><div class="data-label">JK</div><div class="data-val">'+safe(u.jk)+'</div></div><div class="data-row"><div class="data-label">Agama</div><div class="data-val">'+safe(u.agama)+'</div></div><div class="data-row"><div class="data-label">HP/WA</div><div class="data-val">'+safe(u.hp)+'</div></div><div class="data-row"><div class="data-label">Email</div><div class="data-val" style="max-width:60%">'+safe(u.email)+'</div></div><div class="data-row"><div class="data-label">Alamat</div><div class="data-val" style="max-width:60%">'+safe(u.alamat)+'</div></div></div></div>';
    
    html += '<div class="info-card"><div class="info-header"><i class="fa fa-building"></i> INSTANSI</div><div class="info-body"><div class="data-row"><div class="data-label">Unit</div><div class="data-val">'+safe(u.unit)+'</div></div><div class="data-row"><div class="data-label">Jabatan</div><div class="data-val">'+safe(u.jabatan)+'</div></div><div class="data-row"><div class="data-label">Pendidikan</div><div class="data-val">'+safe(u.pendidikan)+'</div></div><div class="data-row"><div class="data-label">Status Sek</div><div class="data-val">'+safe(u.status_sekolah)+'</div></div><div class="data-row"><div class="data-label">Jenjang</div><div class="data-val">'+safe(u.jenjang)+'</div></div><div class="data-row"><div class="data-label">Mulai Tugas</div><div class="data-val">'+safe(u.mulai_tugas)+'</div></div><div class="data-row"><div class="data-label">Status Peg</div><div class="data-val">'+safe(u.status_pegawai)+'</div></div><div class="data-row"><div class="data-label">Provinsi</div><div class="data-val">'+safe(u.provinsi)+'</div></div><div class="data-row"><div class="data-label">Kabupaten</div><div class="data-val">'+safe(u.kabupaten)+'</div></div></div></div>';
    
    html += '<div class="info-card"><div class="info-header"><i class="fa fa-users"></i> KEANGGOTAAN</div><div class="info-body"><div class="data-row"><div class="data-label">NIA</div><div class="data-val" style="color:#4f46e5;font-weight:bold">'+safe(u.nia_lengkap)+'</div></div><div class="data-row"><div class="data-label">Jab. Org</div><div class="data-val">'+safe(u.jabatan_org)+'</div></div><div class="data-row"><div class="data-label">Tingkat</div><div class="data-val">'+safe(u.tingkat_pengurus)+'</div></div><div class="data-row"><div class="data-label">Status</div><div class="data-val">'+safe(u.status_anggota)+'</div></div><div class="data-row"><div class="data-label">Masa KTA</div><div class="data-val" style="color:#d97706;font-weight:bold">'+safe(u.masa_kta)+'</div></div>';
    
    var isAktif = (u.status_anggota === 'AKTIF');
    var isLengkap = isNiaComplete(u);
    
    if(u.link_kta && u.link_kta.length > 5) { 
        if(isAktif && isLengkap) { html += '<a href="'+u.link_kta+'" target="_blank" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:15px">Download KTA (PDF)</a>'; } 
        else { html += '<button onclick="Swal.fire(\'Terkunci\',\'Lengkapi Data & Status Harus AKTIF\',\'warning\')" class="btn btn-outline" style="width:100%;margin-top:15px;background:#eee;color:#777"><i class="fa fa-lock"></i> KTA PDF Terkunci</button>'; }
    }
    
    if(isAktif && isLengkap) {
        html += '<button onclick="checkAndOpenKta(appData.user.data)" class="btn btn-orange" style="width:100%;margin-top:10px">Buat KTA Digital</button>';
        html += '<button onclick="checkAndDownloadBg(appData.user.data)" class="btn btn-outline" style="width:100%;margin-top:10px;border-style:dashed;color:#4f46e5"><i class="fa fa-image"></i> Unduh KTA Belakang</button>';
    } else {
        html += '<button onclick="Swal.fire(\'Info\',\'Lengkapi NIA & Status AKTIF\',\'info\')" class="btn btn-outline" style="width:100%;margin-top:10px;background:#eee;color:#777">KTA Digital Pending</button>';
    }
    
    html += '</div></div></div></div>';
    html += '<div style="color:#64748b;opacity:0.9;margin-top:auto;padding:20px;text-align:center;font-size:12px;line-height:1.6; border-top:1px solid #e2e8f0;">';
    html += 'Â© '+new Date().getFullYear()+' '+s.nama+'<br>';
    html += '<a onclick="showPrivacyPolicy()" style="color:#4f46e5;text-decoration:underline;cursor:pointer;font-weight:600">Kebijakan Privasi</a> â€¢ Hak Cipta Dilindungi.</div></div></div></div>';
    document.getElementById('app').innerHTML = html;
}

// --- FUNGSI KLIK DAN POPUP ---
function viewDetail(idx) { 
    try {
        if (!appData.members || !appData.members[idx]) return;
        var d = appData.members[idx]; currentDetailMember = d; var safe=v=>(v && v!=='undefined')?v:'-'; 
        
        document.getElementById('dName').innerText = d.nama; 
        document.getElementById('dFoto').src = getImageUrl(d.foto); 
        document.getElementById('dJob').innerText = safe(d.jabatan)+" ("+safe(d.unit)+")"; 
        
        var stColor = 'color:#666';
        if(d.status_anggota === 'AKTIF') stColor = 'color:green';
        if(String(d.status_anggota).includes('NONAKTIF')) stColor = 'color:red';
        document.getElementById('dStatus').innerHTML = '<span style="'+stColor+';font-weight:bold">'+(d.status_anggota||'BELUM AKTIF')+'</span>'; 
        
        var html = '<div class="data-row"><div class="data-label">ID</div><div>'+d.id+'</div></div>';
        html += '<div class="data-row"><div class="data-label">NIK</div><div>'+safe(d.nik)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Agama</div><div>'+safe(d.agama)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">HP</div><div>'+safe(d.hp)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Email</div><div>'+safe(d.email)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">TTL</div><div>'+safe(d.tempat_lahir)+', '+safe(d.tgl_lahir)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Jenjang</div><div>'+safe(d.jenjang)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Mulai</div><div>'+safe(d.mulai_tugas)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Alamat</div><div>'+safe(d.alamat)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">NIA</div><div>'+safe(d.nia_lengkap)+'</div></div>';
        html += '<div class="data-row"><div class="data-label">Masa</div><div>'+safe(d.masa_kta)+'</div></div>';
        
        document.getElementById('dContent').innerHTML = html; 
        
        var btns = ''; 
        if(d.link_kta && d.link_kta.length > 5) { 
            var isAktif = (d.status_anggota === 'AKTIF');
            if(isAktif) { btns += '<a href="'+d.link_kta+'" target="_blank" class="btn btn-primary" style="width:100%;margin-bottom:5px">Download KTA (PDF)</a>'; } 
            else { btns += '<button type="button" class="btn btn-outline" style="width:100%;margin-bottom:5px;background:#eee;color:#777" onclick="Swal.fire(\'Terkunci\',\'Status Anggota belum AKTIF. Hubungi Admin.\',\'warning\')"><i class="fa fa-lock"></i> KTA PDF Terkunci</button>'; } 
        } 
        
        if(d.status_anggota === 'AKTIF' && isNiaComplete(d)) {
             btns += '<button onclick="checkAndOpenKta(appData.members['+idx+'])" class="btn btn-orange" style="width:100%;margin-top:5px">Buat KTA Digital (PNG)</button>';
        } else {
             btns += '<button onclick="Swal.fire(\'Info\',\'Data belum lengkap atau belum aktif\',\'info\')" class="btn btn-outline" style="width:100%;margin-top:5px;font-size:12px">Preview KTA Belum Tersedia</button>';
        }
        document.getElementById('dAction').innerHTML = btns; 
        openModal('detailModal'); 
    } catch(e) { console.error(e); Swal.fire('Error', 'Gagal memuat detail', 'error'); }
}

function switchSearchMode(mode) { currentSearchMode = mode; document.getElementById('searchResultArea').style.display = 'none'; if(mode === 'nik') { document.getElementById('searchBoxNik').style.display = 'block'; document.getElementById('searchBoxBio').style.display = 'none'; document.getElementById('btnModeNik').className = 'btn btn-sm btn-primary'; document.getElementById('btnModeBio').className = 'btn btn-sm btn-outline'; } else { document.getElementById('searchBoxNik').style.display = 'none'; document.getElementById('searchBoxBio').style.display = 'block'; document.getElementById('btnModeNik').className = 'btn btn-sm btn-outline'; document.getElementById('btnModeBio').className = 'btn btn-sm btn-primary'; } }
function openSearchModal() { document.getElementById('publicNikInput').value = ""; document.getElementById('publicNameInput').value = ""; document.getElementById('publicTglInput').value = ""; document.getElementById('searchResultArea').style.display = "none"; switchSearchMode('nik'); openModal('searchModal'); }

// FETCH API SEARCH PENGGANTI google.script.run
function handlePublicSearch() { 
    var payload = {}; 
    if (currentSearchMode === 'nik') { 
        var nik = document.getElementById('publicNikInput').value; 
        if(nik.length < 5) { Swal.fire('Input Salah', 'Masukkan NIK dengan benar', 'warning'); return; } 
        payload = { nik: nik }; 
    } else { 
        var nama = document.getElementById('publicNameInput').value; 
        var tgl = document.getElementById('publicTglInput').value; 
        if(nama.length < 3) { Swal.fire('Nama Pendek', 'Masukkan minimal 3 huruf nama', 'warning'); return; } 
        if(!tgl) { Swal.fire('Tanggal', 'Pilih tanggal lahir', 'warning'); return; } 
        payload = { nama: nama, tgl: tgl }; 
    } 
    
    showLoader(true); 
    apiCall('searchMemberPublic', payload).then(function(res){ 
        showLoader(false); 
        var area = document.getElementById('searchResultArea'); area.style.display = "block"; 
        if(res.found) { 
            var html = '<h4 style="margin:0 0 10px 0;color:#16a34a"><i class="fa fa-check-circle"></i> Data Ditemukan.</h4>'; 
            html += '<strong>'+res.nama+'</strong><br><span style="color:#666">NIA: <b style="color:#4f46e5">'+(res.nia||"Belum Ada")+'</b></span><br><span style="color:#666">'+(res.kabupaten||"-")+'</span><br>'; 
            var badgeColor = res.status === 'AKTIF' ? '#dcfce7' : '#ffedd5'; var textColor = res.status === 'AKTIF' ? '#16a34a' : '#c2410c'; 
            html += '<span style="color:#666">Status: <span style="background:'+badgeColor+';color:'+textColor+';padding:2px 8px;border-radius:4px;font-size:11px;font-weight:bold">'+res.status+'</span></span>'; 
            html += '<div style="margin-top:10px;font-size:12px;color:#666;border-top:1px solid #eee;padding-top:10px">Silakan Login menggunakan NIA/Username dan Password Anda. <br> - Bagi anggota yang pertama kali login, harus menggunakan password standar (123456).</div>'; 
            area.innerHTML = html; 
        } else { 
            area.innerHTML = '<h4 style="margin:0 0 10px 0;color:#ef4444"><i class="fa fa-times-circle"></i> Data Tidak Ditemukan</h4><p style="margin:0;font-size:13px;color:#666">Pastikan data yang dimasukkan sesuai (NIK atau Nama & Tgl Lahir).</p>'; 
        } 
    }).catch(function(e) { showLoader(false); Swal.fire('Error', 'Gagal pencarian: '+e.message, 'error'); }); 
}

function openRegistrationModal() { document.getElementById('formReg').reset(); document.getElementById('r_preview').innerHTML = ""; document.getElementById('r_base64').value = ""; document.getElementById('r_preview_container').style.display = 'none'; if (appData.settings) { document.getElementById('lblRegOrg').innerText = appData.settings.nama; document.getElementById('lblRegProv').innerText = appData.settings.provinsi_default; } var provSelect = document.getElementById('r_prov'); if (provSelect.options.length <= 1) { loadProvinces(); } setTimeout(function() { var pId = setProvDropdown('r_prov', appData.settings.provinsi_default); if(pId) loadRegencies(pId, 'r_kab'); }, 800); openModal('regModal'); }

function handleFileAndCrop(event) { var file = event.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(e) { document.getElementById('r_preview_container').style.display = 'block'; document.getElementById('final_preview_container').innerHTML = ''; if (croppieInstance) croppieInstance.destroy(); croppieInstance = new Croppie(document.getElementById('crop_area'), { viewport: { width: 150, height: 200, type: 'square' }, boundary: { width: 300, height: 300 }, showZoomer: true, enableOrientation: true }); croppieInstance.bind({ url: e.target.result }); }; reader.readAsDataURL(file); }
function saveCrop() { if (!croppieInstance) return; croppieInstance.result({ type: 'base64', size: { width: 600, height: 800 }, format: 'jpeg', quality: 0.8 }).then(function(base64) { document.getElementById('r_base64').value = base64; document.getElementById('r_preview_container').style.display = 'none'; document.getElementById('final_preview_container').innerHTML = '<p style="color:green; font-size:12px">Foto Berhasil Dikunci!</p><img src="'+base64+'" style="width:120px; border-radius:8px; border:2px solid #10b981">'; notify('success', 'Foto Siap!', ''); }); }

// FETCH API PENDAFTARAN PENGGANTI google.script.run
function handleRegistration(e) { 
    e.preventDefault(); 
    var nikInput = document.getElementById('r_nik').value;
    if (nikInput.length !== 16) { Swal.fire('Format Salah', 'NIK / No. KTP harus berjumlah tepat 16 digit angka.', 'warning'); return; }
    var b64 = document.getElementById('r_base64').value; 
    if(!b64) { Swal.fire('Foto Wajib', 'Silakan upload dan tunggu proses crop foto selesai.', 'warning'); return; } 

    var submitBtn = e.target.querySelector('button[type="submit"]');
    var originalBtnHtml = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> MEMPROSES...';
    
    showLoader(true, 'MENGUNGGAH DATA...'); 
    
    // 1. Upload Foto via API dulu
    apiCall('uploadToDrive', { base64Data: b64, filename: "REG_" + nikInput }).then(function(url) { 
        if(!url) { showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnHtml; Swal.fire('Error', 'Gagal upload foto ke server.', 'error'); return; }

        var formData = { 
            nik: nikInput, nama: document.getElementById('r_nama').value, tempat_lahir: document.getElementById('r_tmp').value, 
            tgl_lahir: document.getElementById('r_tgl').value, jk: document.getElementById('r_jk').value, 
            agama: document.getElementById('r_agama').value, hp: document.getElementById('r_hp').value, 
            email: document.getElementById('r_email').value, pendidikan: document.getElementById('r_pend').value, 
            alamat: document.getElementById('r_alamat').value, unit: document.getElementById('r_unit').value, 
            jabatan: document.getElementById('r_jab').value, status_pegawai: document.getElementById('r_statPeg').value, 
            status_sekolah: document.getElementById('r_statSek').value, // <--- INI TAMBAHANNYA
            provinsi: document.getElementById('r_prov').options[document.getElementById('r_prov').selectedIndex].text, 
            kabupaten: document.getElementById('r_kab').value, foto_url: url 
        };

        // 2. Simpan Data Registrasi
        return apiCall('checkAndRegisterMember', formData);
    }).then(function(res) { 
        showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnHtml; 
        if(res.status === 'success') { 
            closeModal('regModal'); Swal.fire({ icon: 'success', title: 'Pendaftaran Berhasil!', html: 'Silakan Login dengan:<br><b>Username: ' + res.username + '</b><br><b>Password: ' + res.password + '</b><br><br><small>Harap segera lengkapi data dan cek status.</small>', confirmButtonText: 'SAYA MENGERTI' }); 
        } else if(res.status === 'duplicate') { 
            Swal.fire('Data Ganda', res.message, 'warning'); 
        } else { 
            Swal.fire('Gagal', res.message, 'error'); 
        } 
    }).catch(function(err) {
        showLoader(false); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnHtml; Swal.fire('Error System', err.message, 'error');
    });
}

function showPrivacyPolicy() { var s = appData.settings || {nama: 'Organisasi'}; var html = '<div style="text-align:left; font-size:13px; color:#333; max-height:350px; overflow-y:auto; padding-right:5px; line-height:1.6"><p><strong>Terakhir Diperbarui: '+new Date().toLocaleDateString('id-ID')+'</strong></p><h4>1. Pendahuluan</h4><p>Selamat datang di sistem pendataan dan keanggotaan <b>'+s.nama+'</b>. Kami menghargai dan berkomitmen penuh untuk melindungi privasi serta Data Pribadi Anda. Kebijakan Privasi ini menjelaskan bagaimana kami mengumpulkan, menggunakan, memproses, menyimpan, dan melindungi Data Pribadi Anda saat Anda menggunakan aplikasi atau layanan kami (termasuk pendaftaran Kartu Tanda Anggota/KTA). <br><br> Dengan mendaftar, mengakses, atau menggunakan layanan kami, Anda menyatakan bahwa Anda telah membaca, memahami, dan menyetujui seluruh ketentuan dalam Kebijakan Privasi ini.</p><h4>2. Informasi dan Data Pribadi yang Kami Kumpulkan</h4><p>Dalam mengelola keanggotaan, kami mengumpulkan beberapa kategori Data Pribadi, termasuk namun tidak terbatas pada:<ul><li>Data Identitas Diri: Nama lengkap, Nomor Induk Kependudukan (NIK), tempat/tanggal lahir, jenis kelamin, dan pas foto/KTP.</li><li>Data Kontak: Alamat email, nomor telepon/WhatsApp, dan alamat domisili.</li><li>Data Profesi/Pekerjaan: Nama instansi/sekolah tempat bekerja, jabatan/tugas, status kepegawaian, dan informasi wilayah/provinsi penugasan.</li><li>Data Teknis (Otomatis): Alamat IP (Internet Protocol), jenis peramban (browser), waktu akses, dan statistik penggunaan aplikasi untuk keperluan evaluasi sistem</li></ul></p><h4>3. Tujuan Penggunaan Data Pribadi</h4><p>Data Pribadi yang Anda berikan akan dikelola dan digunakan secara wajar sesuai dengan tujuan organisasi, yaitu untuk:<ul><li>Memproses pendaftaran, verifikasi, dan penerbitan Kartu Tanda Anggota (KTA).</li><li>Mengelola dan memperbarui basis data (database) anggota kepegawaian tata usaha/administrasi sekolah di tingkat nasional maupun wilayah.</li><li>Berkomunikasi dengan Anda terkait informasi organisasi, program kerja, musyawarah, dan pembaruan layanan.</li><li>Mencegah penipuan, penyalahgunaan, atau aktivitas ilegal lainnya dalam sistem kami.</li><li>Memenuhi kewajiban hukum atau peraturan perundang-undangan yang berlaku di Indonesia.</li></ul></p><h4>4. Pembagian dan Pengungkapan Data Pribadi Kami tidak akan menjual, menyewakan, atau menukar</h4><p>Data Pribadi Anda kepada pihak ketiga untuk tujuan komersial. Kami hanya dapat membagikan Data Pribadi Anda dalam kondisi berikut:<ul><li>Pengurus Internal: Hanya dapat diakses oleh admin pusat dan admin provinsi yang memiliki wewenang untuk keperluan verifikasi keanggotaan.</li><li>Penyedia Layanan (Pihak Ketiga): Pihak yang membantu kami mengoperasikan sistem (seperti layanan hosting atau Google Cloud/Drive yang digunakan sebagai infrastruktur aplikasi), yang terikat oleh kewajiban kerahasiaan.</li><li>Kewajiban Hukum: Jika diwajibkan oleh aparat penegak hukum, pengadilan, atau instansi pemerintah yang berwenang berdasarkan hukum Republik Indonesia.</li></ul></p><h4>5. Keamanan Data Pribadi</h4><p>Kami mengambil langkah-langkah teknis dan administratif yang wajar untuk melindungi Data Pribadi Anda dari akses, penggunaan, modifikasi, atau kebocoran yang tidak sah. Data Anda disimpan di dalam server/database yang dilindungi oleh protokol enkripsi dan sistem keamanan (termasuk enkripsi password menggunakan SHA-256). Namun, perlu diingat bahwa tidak ada transmisi data melalui internet yang 100% aman, sehingga kami mengimbau Anda untuk tetap menjaga kerahasiaan kredensial (username & password) Anda.</p><h4>6. Hak Anda sebagai Pemilik Data</h4><p>Sesuai dengan Undang-Undang yang berlaku, Anda memiliki hak penuh atas Data Pribadi Anda, meliputi:<ul><li>Hak untuk meminta akses dan salinan Data Pribadi Anda yang kami simpan.</li><li>Hak untuk memperbarui atau mengoreksi Data Pribadi yang tidak akurat (dapat diajukan melalui Admin Provinsi atau Admin Pusat).</li><li>Hak untuk meminta penghapusan Data Pribadi Anda jika Anda memutuskan untuk berhenti dari keanggotaan.</li></ul></p><h4>7. Penyimpanan dan Retensi Data</h4><p>Kami akan menyimpan Data Pribadi Anda selama Anda masih berstatus sebagai anggota aktif, atau selama diperlukan untuk memenuhi tujuan pengumpulan data sebagaimana disebutkan dalam kebijakan ini, serta untuk mematuhi kewajiban penyimpanan data berdasarkan hukum yang berlaku.</p><h4>8. Perubahan pada Kebijakan Privasi</h4><p>Organisasi berhak untuk mengubah, memodifikasi, atau memperbarui Kebijakan Privasi ini kapan saja untuk menyesuaikan dengan dinamika organisasi maupun peraturan hukum yang baru. Jika terjadi perubahan materiil, kami akan memberitahukan kepada anggota melalui pengumuman di aplikasi atau melalui kontak resmi.</p><h4>9. Hubungi Kami</h4><p>Jika Anda memiliki pertanyaan, keluhan, atau ingin menggunakan hak privasi Anda terkait Data Pribadi, silakan hubungi kami melalui:<ul><li>Helpdesk Admin Pusat: 0852 1990 1909</li><li>Email Resmi: atasindonesia.kab.tebo@gmail.com.</li></ul></p></div>'; Swal.fire({ title: 'Kebijakan Privasi', html: html, width: 600, confirmButtonText: 'Saya Mengerti', confirmButtonColor: '#4f46e5' }); }

function showForgotInfo() { 
    var s = appData.settings || {};
    var wa = s.wa || ''; 
    var namaAdmin = s.nama_admin_prov ? ' - ' + s.nama_admin_prov + '' : '';
    
    var waLink = wa ? '<a href="https://wa.me/'+wa+'" target="_blank" style="color:#4f46e5;font-weight:bold;text-decoration:underline;font-size:16px"><i class="fab fa-whatsapp"></i> Helpdesk Prov : '+wa+namaAdmin+'</a>' : 'Hubungi Admin Pusat'; 
    
    Swal.fire({ 
        title: 'Lupa Password?', 
        html: '<div style="text-align:center;color:#333;font-size:14px">Silahkan hubungi admin Anda untuk mereset password.<br><br>' + waLink + '</div>', 
        icon: 'info', 
        confirmButtonText: 'Tutup' 
    }); 
}

function togglePasswordLogin() { var x = document.getElementById("p"); var i = document.getElementById("togglePass"); if (x.type === "password") { x.type = "text"; i.classList.replace('fa-eye', 'fa-eye-slash'); } else { x.type = "password"; i.classList.replace('fa-eye-slash', 'fa-eye'); } }
function togglePassVisibility(inputId, iconEl) { var x = document.getElementById(inputId); if (x.type === "password") { x.type = "text"; iconEl.classList.replace('fa-eye', 'fa-eye-slash'); } else { x.type = "password"; iconEl.classList.replace('fa-eye-slash', 'fa-eye'); } }

// FETCH API LOGIN PENGGANTI google.script.run
function doLogin(e) { 
    e.preventDefault(); showLoader(true); 
    apiCall('loginUser', { username: document.getElementById('u').value, password: document.getElementById('p').value }).then(function(res) { 
        showLoader(false); 
        if(res.status === 'success') { 
            appData.user = res; localStorage.setItem('atas_session', JSON.stringify(res)); notify('success', 'Berhasil Masuk', ''); res.role.includes('admin') ? renderAdmin() : renderMember(); 
        } else { Swal.fire('Gagal Login', res.message, 'error'); } 
    }).catch(function(err) { showLoader(false); Swal.fire('Error', err.message, 'error'); }); 
}

function doLogout() { Swal.fire({ title: 'Keluar?', text: "Sesi akan berakhir.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' }).then((r) => { if (r.isConfirmed) { localStorage.removeItem('atas_session'); appData.user = null; renderLogin(); } }); }

// FETCH API WILAYAH PENGGANTI google.script.run
function loadProvinces(){ apiCall('getProvincesFromSheet').then(function(res){ var o='<option value="">Pilih...</option>'; res.forEach(p=>{ o+='<option value="'+p+'">'+p+'</option>'; }); if(document.getElementById('m_prov')) document.getElementById('m_prov').innerHTML=o; if(document.getElementById('s_prov')) document.getElementById('s_prov').innerHTML=o; if(document.getElementById('r_prov')) document.getElementById('r_prov').innerHTML=o; }).catch(e=>console.log(e)); }
function loadRegencies(provName, targetId, selectedVal){ if(!provName || provName === ""){ document.getElementById(targetId).innerHTML='<option>Pilih Prov</option>'; return; } document.getElementById(targetId).innerHTML='<option>Loading...</option>'; apiCall('getRegenciesFromSheet', {provName: provName}).then(function(res){ var o='<option value="">Pilih...</option>'; res.forEach(d=>{ var s = (selectedVal && selectedVal === d) ? 'selected' : ''; o+='<option value="'+d+'" '+s+'>'+d+'</option>'; }); document.getElementById(targetId).innerHTML=o; }).catch(e=>console.log(e)); }
function setProvDropdown(sid, n){ var s=document.getElementById(sid); if(!s || s.options.length <= 1) return null; for(var i=0;i<s.options.length;i++) if(s.options[i].value === n){ s.selectedIndex=i; return s.options[i].value; } return null; }

function switchTab(t){ document.getElementById('viewDash').className = 'hidden'; document.getElementById('viewData').className = 'hidden'; if(document.getElementById('viewSetting')) document.getElementById('viewSetting').className = 'hidden'; document.getElementById('mDash').className = 'menu-item'; document.getElementById('mData').className = 'menu-item'; if(document.getElementById('mSet')) document.getElementById('mSet').className = 'menu-item'; if(t === 'dash') { document.getElementById('viewDash').className = ''; document.getElementById('mDash').className = 'menu-item active'; loadDashboardStats(); } else if(t === 'data') { document.getElementById('viewData').className = ''; document.getElementById('mData').className = 'menu-item active'; } else if(t === 'setting') { document.getElementById('viewSetting').className = ''; document.getElementById('mSet').className = 'menu-item active'; } if(window.innerWidth <= 768) { var sb = document.querySelector('.sidebar'); if(sb && sb.classList.contains('active')) toggleSidebar(); } }
function loadData() { adminState.page = 1; fetchDataServer(); }
function handleSearch() { adminState.search = document.getElementById('sKey').value; adminState.fUnit = document.getElementById('fUnit').value; adminState.fStatus = document.getElementById('fStatus').value; adminState.fKab = document.getElementById('fKab').value; adminState.page = 1; fetchDataServer(); }
function changePage(delta) { var newPage = adminState.page + delta; if (newPage < 1) return; var maxPage = Math.ceil(adminState.totalData / adminState.limit); if (newPage > maxPage && maxPage > 0) return; adminState.page = newPage; fetchDataServer(); }

// FETCH API DATA TABEL PENGGANTI google.script.run
function fetchDataServer() { 
    var tbody = document.getElementById('tableBody'); 
    if(tbody) {
        clearInterval(tableLoaderInterval); var timer = 5;
        tbody.innerHTML = '<tr><td colspan="6" align="center" style="padding:40px 0;"><div class="spinner" style="width:40px;height:40px;margin:0 auto 15px"></div><div id="tableLoadText"><span style="font-weight:600; color:#4f46e5; font-size:14px;">Mengambil Data Anggota...</span><br><span style="font-size:28px; color:#ef4444; font-weight:900; display:block; margin-top:5px;">' + timer + '</span></div></td></tr>';
        tableLoaderInterval = setInterval(function() {
            timer--; var txtEl = document.getElementById('tableLoadText');
            if(txtEl) {
                if(timer > 0) { txtEl.innerHTML = '<span style="font-weight:600; color:#4f46e5; font-size:14px;">Mengambil Data Anggota...</span><br><span style="font-size:28px; color:#ef4444; font-weight:900; display:block; margin-top:5px;">' + timer + '</span>'; } 
                else { clearInterval(tableLoaderInterval); txtEl.innerHTML = '<span style="font-weight:600; color:#ea580c; font-size:14px;">Membaca Database Besar...</span><br><span style="font-size:12px; color:#64748b;">(Proses ini bisa makan waktu jika data ribuan)</span>'; }
            } else { clearInterval(tableLoaderInterval); }
        }, 1000);
    }
    
    document.getElementById('pageInfo').innerText = 'Loading...'; 
    var payload = { page: adminState.page, limit: adminState.limit, searchKey: adminState.search, filterUnit: adminState.fUnit, filterStatus: adminState.fStatus, filterKab: adminState.fKab };
    
    apiCall('getMembersPaged', payload).then(function(res){ 
        clearInterval(tableLoaderInterval); appData.members = res.data; adminState.totalData = res.total; renderTableServer(res.data); renderPaginationInfo(res); 
    }).catch(function(err){
        clearInterval(tableLoaderInterval); if(tbody) tbody.innerHTML = '<tr><td colspan="6" align="center" style="color:#ef4444; padding:20px; font-weight:bold;">Gagal mengambil data dari server. Silakan klik tombol Refresh.</td></tr>';
    }); 
}

function renderTableServer(data) { var b = document.getElementById('tableBody'); if(!b) return; var h = ''; if(data.length === 0) { h='<tr><td colspan="6" align="center" style="padding:20px;color:#999">Data Tidak Ditemukan</td></tr>'; } else { data.forEach((m, i) => { var color = '#f3f4f6'; var textColor = '#6b7280'; if(m.status_anggota=='AKTIF') { color='#dcfce7'; textColor='#16a34a'; } else if(m.status_anggota=='PENSIUN') { color='#e0e7ff'; textColor='#4338ca'; } else if(String(m.status_anggota).includes('NONAKTIF')) { color='#fee2e2'; textColor='#dc2626'; } else { color='#ffedd5'; textColor='#c2410c'; } h+='<tr><td><b style="color:#6366f1">'+m.id+'</b></td><td>'+m.nama+'</td><td>'+(m.kabupaten||'-')+'</td><td>'+(m.unit||'-')+'</td><td><span class="badge" style="background:'+color+';color:'+textColor+';padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700">'+(m.status_anggota||'BELUM AKTIF')+'</span></td><td style="display: flex; flex-direction: column; gap: 5px; align-items: center;"><div style="display: flex; gap: 3px;"><button class="btn btn-sm btn-outline" type="button" onclick="viewDetail('+i+')" title="Lihat"><i class="fa fa-eye"></i></button><button class="btn btn-sm btn-outline" type="button" onclick="openAdminModal('+i+')" title="Edit"><i class="fa fa-edit"></i></button>'; if(m.link_kta) { h+='<a href="'+m.link_kta+'" target="_blank" class="btn btn-sm btn-green" title="Unduh KTA (PDF)" style="width: 100%; justify-content: center;"><i class="fa fa-download"></i> PDF</a>'; } h+='<button class="btn btn-sm btn-red" onclick="delMember(\''+m.nik+'\')" title="Hapus" style="width: 100%; justify-content: center;"><i class="fa fa-trash"></i></button></td></tr>'; }); } b.innerHTML = h; }
function renderPaginationInfo(res) { var start = (res.currentPage - 1) * 10 + 1; var end = start + res.data.length - 1; if(res.total === 0) { start = 0; end = 0; } document.getElementById('pageInfo').innerText = 'Hal ' + res.currentPage + ' / ' + res.totalPages + ' | Data: ' + start + '-' + end + ' dari ' + res.total; }

// FETCH API STATS & FILTER PENGGANTI google.script.run
function loadDashboardStats() { apiCall('getDashboardStats').then(function(stats){ document.getElementById('stTot').innerText = stats.total; document.getElementById('stAct').innerText = stats.aktif; document.getElementById('stBelum').innerText = stats.belum; if(chartInstance) chartInstance.destroy(); var ctx = document.getElementById('cityChart'); if(ctx) { chartInstance=new Chart(ctx, { type:'bar', data:{ labels: Object.keys(stats.sebaran), datasets:[{ label:'Jumlah Anggota', data: Object.values(stats.sebaran), backgroundColor:'#4f46e5', borderRadius:5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{display:false} } } }); } }).catch(e=>console.log(e)); }
function populateFilters() { apiCall('getFilterOptions').then(function(res){ var uHTML = '<option value="">Semua Unit</option>'; res.units.forEach(u => { uHTML += '<option value="'+u+'">'+u+'</option>'; }); document.getElementById('fUnit').innerHTML = uHTML; var kHTML = '<option value="">Semua Wilayah</option>'; res.kabs.forEach(k => { kHTML += '<option value="'+k+'">'+k+'</option>'; }); document.getElementById('fKab').innerHTML = kHTML; }).catch(e=>console.log(e)); }

function previewLogoSetting(e) { var file = e.target.files[0]; if(file) { var reader = new FileReader(); reader.onload = function(e) { document.getElementById('preview_logo_set').src = e.target.result; }; reader.readAsDataURL(file); } }

// FETCH API SIMPAN SETTING PENGGANTI google.script.run
function handleSaveSetting(e) { 
    e.preventDefault(); Swal.fire({ title: 'Menyimpan...', text: 'Mohon tunggu', allowOutsideClick: false, didOpen:()=>{Swal.showLoading()} }); 
    var fileInput = document.getElementById('file_logo'); 
    
    var saveFinalData = function(finalLogoUrl) { 
        var d = { nama: document.getElementById('set_nama').value, singkatan: document.getElementById('set_singkatan').value, theme: '#4f46e5', logo: finalLogoUrl, running: document.getElementById('set_running').value, hp: document.getElementById('set_hp').value, wa: document.getElementById('set_wa').value, email: document.getElementById('set_email').value, web: document.getElementById('set_web').value, provinsi: document.getElementById('set_prov').value, nama_admin_prov: document.getElementById('set_nama_admin').value };
        apiCall('saveAppSettings', d).then(function(res){ 
            Swal.close(); if(res.status === 'success') { appData.settings = d; appData.settings.provinsi_default = d.provinsi; appData.settings.nama_admin_prov = d.nama_admin_prov; Swal.fire({ icon: 'success', title: 'Berhasil', text: 'Pengaturan disimpan!', timer: 1500, showConfirmButton: false }).then(() => { renderAdmin(); switchTab('dash'); }); } else { Swal.fire('Gagal', res.message, 'error'); } 
        }).catch(err => Swal.fire('Error', err.message, 'error')); 
    }; 
    
    if(fileInput.files.length > 0) { 
        var file = fileInput.files[0]; if(file.size > 2097152) { Swal.fire('Error', 'Max 2MB', 'warning'); return; } 
        var reader = new FileReader(); reader.onload = function(ev) { 
            apiCall('uploadToDrive', {base64Data: ev.target.result, filename: "LOGO_ORG_" + new Date().getTime()}).then(function(newUrl){ if(newUrl) saveFinalData(newUrl); else Swal.fire('Error', 'Gagal upload logo', 'error'); }).catch(e => Swal.fire('Error', e.message, 'error')); 
        }; reader.readAsDataURL(file); 
    } else { saveFinalData(document.getElementById('set_logo_url').value); } 
}

// FETCH API EXPORT PENGGANTI google.script.run
function exportExcel() { 
    var currentSearch = adminState.search; var currentUnit = adminState.fUnit; var currentStatus = adminState.fStatus; var currentKab = adminState.fKab; 
    Swal.fire({ title: 'Menyiapkan Data', text: 'Server sedang merangkum data excel Anda...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } }); 
    
    apiCall('generateExportExcelUrl', {searchKey: currentSearch, filterUnit: currentUnit, filterStatus: currentStatus, filterKab: currentKab}).then(function(res) { 
        if (res.status === 'empty') { Swal.fire('Info', 'Tidak ada data yang sesuai dengan filter pencarian Anda.', 'info'); } 
        else if (res.status === 'success') { Swal.close(); window.location.href = res.url; } 
        else { Swal.fire('Error', res.message, 'error'); }
    }).catch(err => Swal.fire('Error', err.message, 'error')); 
}

function toggleSidebar() { var sb = document.querySelector('.sidebar'); var overlay = document.getElementById('sidebarOverlay'); if (!overlay) { overlay = document.createElement('div'); overlay.id = 'sidebarOverlay'; overlay.className = 'sidebar-overlay'; overlay.onclick = function() { toggleSidebar(); }; document.body.appendChild(overlay); } sb.classList.toggle('active'); overlay.classList.toggle('active'); }

// FETCH API REFRESH PENGGANTI google.script.run
function handleManualRefresh() { 
    if (!appData.user) { notify('warning', 'Silakan login terlebih dahulu', ''); return; } showLoader(true); 
    if (appData.user.role.includes('admin')) { 
        apiCall('getMembersPaged', { page: adminState.page, limit: adminState.limit, searchKey: adminState.search, filterUnit: adminState.fUnit, filterStatus: adminState.fStatus, filterKab: adminState.fKab }).then(function(res) { 
            appData.members = res.data; adminState.totalData = res.total; renderTableServer(res.data); renderPaginationInfo(res); loadDashboardStats(); showLoader(false); notify('success', 'Data Diperbarui', ''); 
        }).catch(err => { showLoader(false); Swal.fire('Gagal',err.message,'error'); }); 
    } else { 
        apiCall('loginUser', { username: appData.user.data.id, password: appData.user.data.password }).then(function(res) { 
            showLoader(false); if(res.status === 'success') { appData.user = res; localStorage.setItem('atas_session', JSON.stringify(res)); renderMember(); notify('success', 'Profil Diperbarui', ''); } 
        }).catch(err => showLoader(false)); 
    } 
}

// FETCH API UPDATE ADMIN PENGGANTI google.script.run
function openAdminProfile() { 
    var u = appData.user.data; 
    document.getElementById('adm_row').value = u.row_index; 
    document.getElementById('adm_user').value = u.username; 
    
    // FIX BUG UNDEFINED: Kosongkan field, karena password lama sudah dienkripsi sistem
    document.getElementById('adm_pass').value = ""; 
    document.getElementById('adm_pass').placeholder = "Ketik password baru/lama di sini..."; 
    
    document.getElementById('adm_name').value = u.nama; 
    openModal('adminProfileModal'); 
}

// FETCH API UPDATE ADMIN PENGGANTI google.script.run
function handleAdminProfileSave(e) { 
    e.preventDefault(); var d = { row_index: document.getElementById('adm_row').value, username: document.getElementById('adm_user').value, password: document.getElementById('adm_pass').value, nama: document.getElementById('adm_name').value }; closeModal('adminProfileModal'); showLoader(true); 
    apiCall('updateAdminAccount', d).then(function(res) { 
        showLoader(false); if(res.status === 'success') { Swal.fire({ title: 'Sukses', text: res.message, icon: 'success', timer:1500, showConfirmButton:false }); appData.user.data.username = d.username; appData.user.data.password = d.password; appData.user.data.nama = d.nama; renderAdmin(); } else { Swal.fire('Gagal', res.message, 'error'); } 
    }).catch(err => { showLoader(false); Swal.fire('Error', err.message, 'error'); }); 
}

function openAdminModal(idx) { openModal('adminModal'); document.getElementById('formMember').reset(); document.getElementById('m_crop_container').style.display = 'none'; document.getElementById('m_preview_final').innerHTML = ""; document.getElementById('m_base64').value = ""; var isSuper = (appData.user && (appData.user.role === 'superadmin' || appData.user.role === 'super')); const superFields = document.getElementById('superAdminFields'); if (superFields) { if (isSuper) { superFields.classList.remove('hidden'); superFields.style.display = 'block'; } else { superFields.classList.add('hidden'); superFields.style.display = 'none'; } } var s = (id,v) => { var e=document.getElementById(id); if(e) e.value=v||''; }; if(idx !== undefined) { var d = appData.members[idx]; s('m_row',d.row_index); s('m_curFoto',d.foto); s('m_linkKta',d.link_kta); s('m_id',d.id); s('m_nik',d.nik); s('m_nama',d.nama); s('m_gelarD',d.gelar_depan); s('m_gelarB',d.gelar_belakang); s('m_jk',d.jk); s('m_agama', d.agama); s('m_tmpLahir',d.tempat_lahir); s('m_tglLahir',d.tgl_lahir); s('m_hp',d.hp); s('m_email',d.email); s('m_pass',d.password); s('m_alamat',d.alamat); s('m_unit',d.unit); s('m_jabatan',d.jabatan); s('m_statPeg',d.status_pegawai); s('m_statSek',d.status_sekolah); s('m_status',d.status_anggota||'BELUM AKTIF'); s('m_nia',d.nia_lengkap); s('m_pend', d.pendidikan); s('m_jabOrg', d.jabatan_org); s('m_masaKta',d.masa_kta); s('m_jenjang', d.jenjang); s('m_mulai', d.mulai_tugas); s('m_tingkat', d.tingkat_pengurus); s('m_ad', d.kode_ad); s('m_ae', d.kode_ae); s('m_af', d.kode_af); if(isSuper){ updateStatusAuto(); } var provId = setProvDropdown('m_prov', d.provinsi); loadRegencies(provId, 'm_kab', d.kabupaten); if(d.foto) document.getElementById('m_preview_final').innerHTML='<img src="'+getImageUrl(d.foto)+'" style="height:100px;border-radius:6px">'; } else { s('m_row',''); if(appData.settings.provinsi_default){ setTimeout(function(){ var p=setProvDropdown('m_prov',appData.settings.provinsi_default); if(p) loadRegencies(p,'m_kab'); },500); } } }
function updateStatusAuto() { var ad = document.getElementById('m_ad').value || ""; var ae = document.getElementById('m_ae').value || ""; var af = document.getElementById('m_af').value || ""; var tgl = document.getElementById('m_tglLahir').value; var tglStr = ""; if(tgl) { var parts = tgl.split('-'); var y = parts[0]; var m = parts[1]; var d = parts[2]; tglStr = y + m + d; var masaKtaYear = parseInt(y) + 58; var masaKtaFull = masaKtaYear + '-' + m + '-' + d; document.getElementById('m_masaKta').value = masaKtaFull; } var niaPreview = ae + af + tglStr + ad; document.getElementById('m_ag').value = niaPreview; document.getElementById('m_nia').value = niaPreview; var currentStatus = document.getElementById('m_status').value; if (currentStatus !== "PENSIUN" && currentStatus !== "NONAKTIF/MUTASI") { if (ae !== "" && af !== "" && ad !== "") { document.getElementById('m_status').value = "AKTIF"; } else { document.getElementById('m_status').value = "BELUM AKTIF"; } } }

// FETCH API SIMPAN ANGGOTA PENGGANTI google.script.run
function handleSave(e) { 
    e.preventDefault(); showLoader(true); 
    var val = function(id) { var el = document.getElementById(id); if(!el) return ""; if(el.type === 'select-one' && el.selectedIndex > 0) return el.options[el.selectedIndex].text; return el.value; }; 
    var d={ row_index: document.getElementById('m_row').value, id_anggota: document.getElementById('m_id').value, nik:val('m_nik'), nama:val('m_nama'), gelar_depan:val('m_gelarD'), gelar_belakang:val('m_gelarB'), jk:val('m_jk'), agama:val('m_agama'), tempat_lahir:val('m_tmpLahir'), tgl_lahir:document.getElementById('m_tglLahir').value, hp:val('m_hp'), email:val('m_email'), password:val('m_pass'), alamat:val('m_alamat'), unit:val('m_unit'), jabatan:val('m_jabatan'), status_sekolah:val('m_statSek'), status_pegawai:val('m_statPeg'), provinsi:val('m_prov'), kabupaten:val('m_kab'), status_anggota: document.getElementById('m_status').value, nia_lama:val('m_nia'), masa_kta: document.getElementById('m_masaKta').value, pendidikan: val('m_pend'), jabatan_org: val('m_jabOrg'), tingkat_pengurus: val('m_tingkat'), link_kta:val('m_linkKta'), jenjang:val('m_jenjang'), mulai_tugas:val('m_mulai'), current_foto:document.getElementById('m_curFoto').value, foto_file_base64:document.getElementById('m_base64').value, kode_ad: document.getElementById('m_ad').value, kode_ae: document.getElementById('m_ae').value, kode_af: document.getElementById('m_af').value }; 
    closeModal('adminModal'); 
    apiCall('saveMemberData', d).then(res => { 
        showLoader(false); if(res.status === 'success') { notify('success','Berhasil', res.message); fetchDataServer(); loadDashboardStats(); } else { Swal.fire('Error', res.message, 'error'); } 
    }).catch(err => { showLoader(false); Swal.fire('Error System', err.message, 'error'); }); 
}

function handleManualCrop(event, targetAreaId, previewId) { var file = event.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(e) { var areaEl = document.getElementById(targetAreaId); areaEl.parentElement.style.display = 'block'; document.getElementById(previewId).innerHTML = '<p style="color:orange; font-size:11px">Sedang memproses crop...</p>'; if (activeCroppie) activeCroppie.destroy(); activeCroppie = new Croppie(areaEl, { viewport: { width: 150, height: 200, type: 'square' }, boundary: { width: 250, height: 300 }, showZoomer: true, enableOrientation: true }); activeCroppie.bind({ url: e.target.result }); }; reader.readAsDataURL(file); }
function executeCrop(areaId, hiddenInputId, containerId, previewId) { if (!activeCroppie) return; activeCroppie.result({ type: 'base64', size: { width: 600, height: 800 }, format: 'jpeg', quality: 0.8 }).then(function(base64) { document.getElementById(hiddenInputId).value = base64; document.getElementById(containerId).style.display = 'none'; document.getElementById(previewId).innerHTML = '<img src="'+base64+'" style="width:100px; height:133px; border-radius:8px; border:2px solid #4f46e5; object-fit:cover">'; notify('success', 'Foto berhasil dikunci', ''); activeCroppie.destroy(); activeCroppie = null; }); }
function openSelfEdit() { document.getElementById('s_crop_container').style.display = 'none'; document.getElementById('s_base64').value = ""; document.getElementById('s_preview_final').innerHTML = ""; openModal('selfEditModal'); var u = appData.user.data; var s = (id,v) => { var e=document.getElementById(id); if(e) e.value=v||''; }; s('s_row',u.row_index); s('s_curFoto',u.foto); s('s_hp',u.hp); s('s_tmpLahir', u.tempat_lahir); s('s_tglLahir', u.tgl_lahir); s('s_email',u.email); s('s_jk',u.jk); s('s_agama', u.agama); s('s_pend',u.pendidikan); s('s_unit',u.unit); s('s_statSek',u.status_sekolah); s('s_jabatan',u.jabatan); s('s_statPeg',u.status_pegawai); s('s_alamat',u.alamat); s('s_jenjang',u.jenjang); s('s_mulai',u.mulai_tugas); document.getElementById('s_base64').value=""; var provId = setProvDropdown('s_prov', u.provinsi); loadRegencies(provId, 's_kab', u.kabupaten); if(u.foto) document.getElementById('s_preview_final').innerHTML='<img src="'+getImageUrl(u.foto)+'" style="height:133px;width:100px;object-fit:cover;border-radius:8px;border:2px solid #eee">'; }

// FETCH API UPDATE PROFILE PENGGANTI google.script.run
function handleSelfSave(e){ 
    e.preventDefault(); showLoader(true); 
    var val=id=>document.getElementById(id).type==='select-one'&&document.getElementById(id).selectedIndex>0?document.getElementById(id).options[document.getElementById(id).selectedIndex].text:document.getElementById(id).value; 
    var d={ 
        row_index:val('s_row'), hp:val('s_hp'), email:val('s_email'), tgl_lahir:val('s_tglLahir'), 
        tempat_lahir:val('s_tmpLahir'), jk:val('s_jk'), agama:val('s_agama'), pendidikan:val('s_pend'), 
        provinsi:val('s_prov'), kabupaten:val('s_kab'), unit:val('s_unit'), jabatan:val('s_jabatan'), 
        status_pegawai:val('s_statPeg'), 
        status_sekolah:val('s_statSek'), // <--- INI TAMBAHANNYA
        alamat:val('s_alamat'), jenjang:val('s_jenjang'), mulai_tugas:val('s_mulai'), 
        current_foto:val('s_curFoto'), foto_file_base64:val('s_base64') 
    }; 
    closeModal('selfEditModal'); 
    apiCall('updateMemberProfile', d).then(res=>{ 
        showLoader(false); if(res.status==='success'){ notify('success','Profil Diupdate',''); appData.user.data=res.data; localStorage.setItem('atas_session', JSON.stringify(appData.user)); renderMember(); } else Swal.fire('Gagal', res.message, 'error'); 
    }).catch(err => { showLoader(false); Swal.fire('Error', err.message, 'error'); }); 
}

// FETCH API HAPUS DATA PENGGANTI google.script.run
function delMember(nik) { 
    if(!nik || nik === "undefined") { Swal.fire('Error', 'Data NIK tidak valid', 'error'); return; }
    var targetMember = appData.members.find(m => String(m.nik).replace(/'/g, "") === String(nik).replace(/'/g, ""));
    var namaAnggota = targetMember ? targetMember.nama : "Nama Tidak Diketahui";
    Swal.fire({ title: 'Hapus Data?', text: "Yakin ingin menghapus NIK: " + nik + " (" + namaAnggota + ")?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' }).then((result) => { 
        if(result.isConfirmed) { 
            appData.members = appData.members.filter(m => String(m.nik).replace(/'/g, "") !== String(nik).replace(/'/g, ""));
            renderTableServer(appData.members); Swal.fire({icon: 'success', title: 'Dihapus!', text: 'Data lenyap seketika.', timer: 1500, showConfirmButton: false});
            apiCall('deleteMember', {nikAnggota: nik}).then(function(res){ 
                if(res === 'OK') { loadDashboardStats(); } else { fetchDataServer(); Swal.fire('Info', 'Gagal hapus di server: ' + res, 'warning'); }
            }).catch(err => Swal.fire('Error', err.message, 'error')); 
        } 
    }); 
}

// FETCH API RESET & GANTI PASSWORD PENGGANTI google.script.run
function resetPass(){ var r = document.getElementById('m_row').value; if(!r || r === "") { Swal.fire('Eits!', 'Simpan dulu data baru.', 'warning'); return; } Swal.fire({ title: 'Reset Password?', text: "Password akan jadi '123456' dan tampil di form.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' }).then((result) => { if(result.isConfirmed){ showLoader(true); apiCall('resetPassword', {rowIndex: r}).then(res => { showLoader(false); if(res === 'SUKSES') { document.getElementById('m_pass').value = "123456"; Swal.fire({ icon:'success', title:'Berhasil', text:'Password kini: 123456', timer:2000, showConfirmButton:false }); fetchDataServer(); } else Swal.fire('Gagal', res, 'error'); }).catch(err => { showLoader(false); Swal.fire('Error', err.message, 'error'); }); } }); }
function openChangePass() { openModal('passModal'); }
function handlePassChange(e) { e.preventDefault(); var oldP = document.getElementById('cp_old').value; var newP = document.getElementById('cp_new').value; var r = appData.user.data.row_index; closeModal('passModal'); showLoader(true); apiCall('changeOwnPassword', {cp_row: r, cp_old: oldP, cp_new: newP}).then(res => { showLoader(false); if(res.status === 'success') { Swal.fire({ icon:'success', title:'Sukses', text:'Password berhasil diubah!', timer:2000, showConfirmButton:false }); } else { Swal.fire('Gagal', res.message, 'error'); } }).catch(err => { showLoader(false); Swal.fire('Error', err.message, 'error'); }); }

// FETCH API GENERATE KTA PENGGANTI google.script.run
function generateKTA() {
    var d = currentDetailMember;
    if (!d) return Swal.fire('Error', 'Pilih anggota', 'error');
    showLoader(true, 'MEMBUAT KTA DIGITAL...');

    const loadImage = (src) => {
        return new Promise((resolve) => {
            if (!src) return resolve(null); const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => resolve(img); img.onerror = () => resolve(null); img.src = src;
        });
    };

    apiCall('getKtaResources', {photoUrl: d.foto, logoUrl: appData.settings.logo}).then(async function(assets) {
        try { await document.fonts.load("bold 21px Oswald"); } catch(e) { console.log(e); }
        const [bgImg, logoImg, photoImg] = await Promise.all([ loadImage(assets.bg), loadImage(assets.logo), loadImage(assets.photo) ]);
        var canvas = document.getElementById('ktaCanvas'); var ctx = canvas.getContext('2d');
        if (bgImg) { ctx.drawImage(bgImg, 0, 0, 600, 380); } else { var grd = ctx.createLinearGradient(0, 0, 600, 0); grd.addColorStop(0, "#4f46e5"); grd.addColorStop(1, "#7c3aed"); ctx.fillStyle = grd; ctx.fillRect(0, 0, 600, 380); }

        var nama = d.nama.length > 30 ? d.nama.substring(0, 30) + "..." : d.nama; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 0; ctx.fillStyle = "black"; ctx.font = "bold 21px Oswald"; 
        var leftX = 160; var topY = 160; 
        ctx.fillText("N I A      : " + (d.nia_lengkap || "-"), leftX, topY); ctx.fillText("Nama     : " + nama, leftX, topY + 28); ctx.fillText("Instansi : " + (d.unit || "-"), leftX, topY + 56); ctx.fillText("Provinsi : " + (d.provinsi || "-"), leftX, topY + 84);

        var qr = new QRious({ value: "ID:" + d.id + "\nNAMA:" + d.nama + "\nNIA:" + d.nia_lengkap, size: 150 }); const qrImg = await loadImage(qr.toDataURL());
        if (qrImg) { ctx.fillStyle = "white"; ctx.fillRect(9, 277, 96, 96); ctx.drawImage(qrImg, 9, 277, 96, 96); }

        var photoX = 25; var photoY = 120; var fixedHeight = 132; var fixedWidth = 99; 
        if (photoImg) { var ratio = photoImg.width / photoImg.height; var newWidth = fixedHeight * ratio; ctx.lineWidth = 5; ctx.strokeStyle = "white"; ctx.strokeRect(photoX, photoY, newWidth, fixedHeight); ctx.drawImage(photoImg, photoX, photoY, newWidth, fixedHeight); } else { ctx.fillStyle = "#cbd5e1"; ctx.fillRect(photoX, photoY, fixedWidth, fixedHeight); ctx.fillStyle = "#64748b"; ctx.font = "12px Arial"; ctx.fillText("No Foto", photoX + 25, photoY + 70); }

        showLoader(false); openModal('ktaGenModal');
        var btnDownload = document.getElementById('downloadKtaBtn'); btnDownload.href = canvas.toDataURL("image/png");
        var namaAman = (d.nama || "Anggota").replace(/[^a-zA-Z0-9]/g, "_"); btnDownload.download = "KTA_Digital_" + namaAman + ".png";
    }).catch(function(err) { showLoader(false); Swal.fire("Gagal", "Koneksi lambat/Error Server: " + err.message, "error"); });
}

function checkAndOpenKta(m) { if(!m) m = currentDetailMember; if(isNiaComplete(m)) { currentDetailMember = m; generateKTA(); } else { Swal.fire({ icon: 'warning', title: 'Akses Ditolak', text: 'Anggota ini belum memiliki NIA lengkap.' }); } }
function checkAndDownloadBg(m) { if(!m) m = currentDetailMember; if(isNiaComplete(m)) { downloadBackground(); } else { Swal.fire({ icon: 'warning', title: 'Akses Ditolak', text: 'Anggota ini belum memiliki NIA lengkap.' }); } }
function isNiaComplete(m) { if (m && m.kode_ad && m.kode_ae && m.kode_af && m.nia_lengkap && m.nia_lengkap.length > 5) { return true; } return false; }

// FETCH API DOWNLOAD BACKGROUND PENGGANTI google.script.run
function downloadBackground() { 
    showLoader(true, 'MENYIAPKAN GAMBAR BELAKANG...'); 
    apiCall('getBackBackgroundBase64').then(function(base64Data){ 
        showLoader(false); 
        if(base64Data && base64Data.length > 50) { 
            var link = document.createElement('a'); link.href = base64Data; link.download = "KTA_Belakang_" + (appData.user.data.nama || "Anggota") + ".png"; 
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Gambar KTA Belakang sudah diunduh.', timer: 2000, showConfirmButton: false });
        } else { Swal.fire('Gagal', 'Gambar Background Belakang belum disetting.', 'error'); } 
    }).catch(function(err){ showLoader(false); Swal.fire('Error', err.message, 'error'); }); 
}

function validateTwoDigit(el) { let val = el.value.replace(/[^0-9]/g, ''); if (val.length > 2) { Swal.fire('Format Salah', 'Kode Wilayah maksimal 2 digit angka.', 'warning'); el.value = ""; } else if (val.length === 1) { el.value = '0' + val; } else { el.value = val; } updateStatusAuto(); }
function validateFourDigit(el) { let val = el.value.replace(/[^0-9]/g, ''); if (val.length > 4) { Swal.fire('Format Salah', 'Nomor Urut maksimal 4 digit angka.', 'warning'); el.value = ""; } else if (val.length > 0 && val.length < 4) { el.value = val.padStart(4, '0'); } else { el.value = val; } updateStatusAuto(); }
function sanitizeNumber(el) { el.value = el.value.replace(/[^0-9]/g, ''); updateStatusAuto(); }

// FETCH API POPUP CONTACT PENGGANTI google.script.run
function openContactPopup() {
    var s = appData.settings || {}; 
    
    // [FIX UTAMA]: Paksa ubah tipe data dari Google Sheets menjadi Teks (String), 
    // karena kalau formatnya murni angka, fungsi manipulasi teks akan error dan menu jadi ZONK!
    var hp = String(s.hp || ''); 
    var web = String(s.web || ''); 
    var email = String(s.email || '');

    var htmlBtns = '<div style="display:flex; flex-direction:column; gap:12px; margin-top:20px;">';
    
    if(hp && hp.length > 3) {
        var cleanNumber = hp.replace(/[^0-9]/g, ''); 
        var waNumber = cleanNumber; 
        if (waNumber.startsWith('0')) { waNumber = '62' + waNumber.substring(1); }
        var telNumber = cleanNumber; 
        if (waNumber.startsWith('62')) { telNumber = '+' + waNumber; }
        
        htmlBtns += '<a href="https://wa.me/'+waNumber+'" target="_blank" class="btn btn-green" style="width:100%; justify-content:center; padding:12px;"><i class="fab fa-whatsapp" style="font-size:18px;"></i> WA Admin Pusat</a>';
        htmlBtns += '<button onclick="window.location.href=\'tel:'+telNumber+'\'" class="btn btn-orange" style="width:100%; justify-content:center; padding:12px; border:none; cursor:pointer; font-family:inherit;"><i class="fa fa-phone" style="font-size:18px;"></i> Telepon Bantuan</button>';
    }
    
    if(web && web.length > 3) { 
        var webUrl = web.startsWith('http') ? web : 'https://' + web; 
        htmlBtns += '<a href="'+webUrl+'" target="_blank" class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;"><i class="fa fa-globe" style="font-size:18px;"></i> Website Resmi</a>'; 
    }
    
    if(email && email.length > 3) { 
        htmlBtns += '<button onclick="window.location.href=\'mailto:'+email+'\'" class="btn btn-outline" style="width:100%; justify-content:center; padding:12px; border-color:#e2e8f0; cursor:pointer; font-family:inherit;"><i class="fa fa-envelope" style="font-size:18px;"></i> Email Kami</button>'; 
    }
    
    if(hp.length < 4 && web.length < 4 && email.length < 4) { 
        htmlBtns += '<p style="color:red; font-size:13px;">Maaf, kontak admin belum diatur.</p>'; 
    }
    
    htmlBtns += '</div>';
    
    Swal.fire({ title: 'Hubungi Kami', text: 'Pilih saluran bantuan di bawah ini:', html: htmlBtns, showConfirmButton: false, showCloseButton: true });
}

</script>

  
</body>
</html>
